#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-commitフック：コミット前に軽量なチェックを実行

echo "🔍 Pre-commit フックを実行しています..."

# ステージングされたファイルのみをチェック
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
    echo "📘 ステージされたTypeScriptファイルをチェック中..."
    
    # 型チェック（変更されたファイルのみ）
    echo "  TypeScript型チェック..."
    npx tsc --noEmit
    
    # ESLintチェック（ステージされたファイルのみ）
    echo "  ESLintチェック..."
    npx eslint $STAGED_FILES --max-warnings 0
    
    # Prettierフォーマットチェック
    echo "  Prettierフォーマットチェック..."
    npx prettier --check $STAGED_FILES
    
    if [ $? -ne 0 ]; then
        echo "❌ Pre-commitチェックに失敗しました。"
        echo "💡 ヒント: 'npm run format' でフォーマットを修正できます。"
        exit 1
    fi
else
    echo "ℹ️  TypeScriptファイルの変更はありません。"
fi

# テストは高速実行のため、変更されたファイルに関連するもののみ実行
if [ -n "$STAGED_FILES" ]; then
    echo "📘 関連するテストを実行中..."
    npm test -- --related $STAGED_FILES --run
    
    if [ $? -ne 0 ]; then
        echo "❌ テストに失敗しました。"
        exit 1
    fi
fi

echo "✅ Pre-commitチェックが成功しました！"