# TASK-001: ベースライン計算システム実装 - 要件定義

## 概要

30日間の履歴データからベースラインメトリクス算出を行うシステムの実装。データ不足時の業界平均値フォールバック機能、断続配信・予算変更対応のベースライン補正機能、信頼度スコア算出を含む。

## 詳細要件

### 機能要件

#### FR-001: 30日間履歴データベースライン算出
- **概要**: 過去30日間のMetaAdInsightsデータからベースラインメトリクスを算出
- **入力**: adId, accountId, 日付範囲
- **出力**: BaselineMetrics（CTR, CPM, Frequency, エンゲージメント率）
- **処理**: 
  - 日次データの平均値計算
  - 異常値（外れ値）の除外
  - 欠損日の補間処理

#### FR-002: データ不足時業界平均値フォールバック
- **概要**: 履歴データが不足する場合の業界平均値使用
- **条件**: 利用可能データが7日未満、または品質スコア0.5未満
- **フォールバック値**:
  - CTR: 2.0% (Facebook), 1.2% (Instagram)
  - CPM: 500円 (Facebook), 600円 (Instagram)  
  - Frequency: 2.5
  - エンゲージメント率: 0.7% (Feed), 1.23% (Reel), 0.5% (Story)

#### FR-003: 断続配信・予算変更対応のベースライン補正
- **概要**: 配信停止期間や予算変更を考慮した補正機能
- **検出条件**:
  - 3日以上連続で配信停止
  - 予算が50%以上変更
  - インプレッションが平均から80%以上減少
- **補正処理**:
  - 配信停止期間のデータ除外
  - 予算変更前後での重み付け調整
  - 補正後の信頼度スコア再計算

#### FR-004: 信頼度スコア算出
- **概要**: ベースライン計算の信頼性を0.0-1.0で評価
- **算出要因**:
  - データ完全性: 利用可能日数 / 30日
  - データ安定性: 標準偏差によるばらつき評価
  - サンプル数: インプレッション数による重み付け
  - 外れ値比率: 除外データ比率
- **信頼度レベル**:
  - 高信頼度: 0.8以上（30日中25日以上のデータ）
  - 中信頼度: 0.5-0.8（30日中15-24日のデータ）
  - 低信頼度: 0.5未満（業界平均使用推奨）

### 非機能要件

#### NFR-001: パフォーマンス要件
- **応答時間**: 500ms以内/広告
- **スループット**: 1000広告同時処理可能
- **メモリ使用量**: 1GB以下での処理

#### NFR-002: 品質要件
- **精度**: CTR/CPM/Frequency基準値の誤差±10%以内
- **可用性**: 99.5%以上
- **データ整合性**: トランザクション保証

#### NFR-003: セキュリティ要件
- **データ暗号化**: Meta APIトークンの暗号化保存
- **アクセス制御**: アカウント単位でのデータ分離
- **監査ログ**: 計算処理の完全ログ記録

## 受け入れ基準

### AC-001: 正常系ベースライン計算
```
GIVEN 30日分のMetaAdInsightsデータが存在する
WHEN BaselineCalculationServiceを呼び出す
THEN 以下の条件を満たすBaselineMetricsが返される:
- CTR/CPM/Frequencyが算出されている
- 信頼度スコアが0.7以上
- 計算期間が正確に設定されている
- 処理時間が500ms以内
```

### AC-002: データ不足時フォールバック
```
GIVEN 履歴データが5日分しか存在しない
WHEN BaselineCalculationServiceを呼び出す
THEN 以下の条件を満たす:
- isIndustryAverageフラグがtrue
- 業界平均値が設定されている
- 信頼度スコアが0.7未満
- フォールバック理由がログに記録される
```

### AC-003: 断続配信補正
```
GIVEN 30日中10日間が配信停止されている
WHEN BaselineCalculationServiceを呼び出す
THEN 以下の条件を満たす:
- 配信停止期間のデータが除外されている
- 実際の配信日数が記録されている
- 補正後の信頼度スコアが算出されている
```

### AC-004: 信頼度スコア算出
```
GIVEN 様々な品質のデータセット
WHEN 信頼度スコアを算出する
THEN 以下の条件を満たす:
- データ完全性が正しく評価されている
- 外れ値の影響が適切に反映されている  
- スコアが0.0-1.0の範囲内
```

### AC-005: パフォーマンス要件
```
GIVEN 1000広告分のベースライン計算要求
WHEN バッチ処理を実行する
THEN 以下の条件を満たす:
- 全処理が10分以内に完了
- メモリ使用量が1GB以下
- エラー率が1%未満
```

## テスト戦略

### 単体テスト
- BaselineCalculationService各メソッドのテスト
- 異常値処理ロジックのテスト
- 信頼度スコア算出ロジックのテスト
- エラーハンドリングテスト

### 結合テスト
- Meta API連携テスト
- Convex Database読み書きテスト
- キャッシュ機能テスト

### パフォーマンステスト
- 1000広告同時処理テスト
- メモリリーク検出テスト
- レスポンス時間測定テスト

## 技術制約

### 使用技術
- **Language**: TypeScript
- **Framework**: Convex
- **Database**: Convex Database
- **Testing**: Vitest + @testing-library
- **API**: Meta Marketing API v18.0

### 外部依存関係
- Meta API レート制限: 200リクエスト/時間
- Convex Database トランザクション制限
- メモリ使用量制限

## リスク・対策

### 高リスク
1. **Meta API レート制限**
   - 対策: バッチ処理の分散実行、キャッシュ活用
2. **大量データ処理性能**
   - 対策: ストリーミング処理、分散計算

### 中リスク  
1. **データ品質の一貫性**
   - 対策: 厳密な検証ロジック、異常値検出
2. **計算精度の保証**
   - 対策: 専門家レビュー、A/Bテスト検証

## 実装優先度

1. **高**: 基本ベースライン計算機能
2. **高**: 業界平均フォールバック機能  
3. **中**: 断続配信補正機能
4. **中**: 信頼度スコア算出機能
5. **低**: パフォーマンス最適化

## 成功指標

- [ ] 単体テストカバレッジ95%以上
- [ ] CTR/CPM/Frequency基準値の精度±10%以内
- [ ] 新規アカウントでの業界平均フォールバック動作確認  
- [ ] 計算時間500ms/広告以下
- [ ] データ品質スコア算出機能の動作確認
- [ ] Convex Database連携機能の動作確認