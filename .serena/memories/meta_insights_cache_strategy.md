# Meta Insights キャッシュ戦略

## 実装方針（2025年1月）

### 現状の問題
1. **全データ再取得**: 毎回すべてのデータを取得しようとしてレート制限に引っかかる
2. **キャッシュの活用不足**: Convex DBがあるのに、単なる一時キャッシュとしてしか使われていない
3. **差分更新なし**: 新規・更新データのみを取得する仕組みがない
4. **200件取得できているのに表示されない**: APIクライアントは200件のデータを返しているが、useMetaInsightsフックで失われている

## 決定した方針: シンプル路線

### Convexを削除してローカルキャッシュのみに移行

**理由:**
- コスト0円
- シンプルな実装
- 即座に実装可能
- Meta APIのレート制限対策に集中できる

### 実装内容

1. **Convex関連コードの削除**
   - convex/ディレクトリ全体を削除
   - ConvexProviderの削除
   - useConvex関連のフックの削除

2. **ローカルキャッシュの実装**
   ```typescript
   const LOCAL_CACHE_KEY = 'meta-insights-cache'
   
   // キャッシュ構造
   {
     accountId: string,
     data: MediaInsight[],
     timestamp: number,
     expiresAt: number // 1時間後
   }
   ```

3. **差分更新ロジック**
   - lastSyncedAt: 最終同期時刻の記録
   - since/until パラメータを使った差分取得
   - 新規データと既存データのマージ

4. **レート制限対策**
   - バッチサイズ: 100件
   - バッチ間の待機時間: 5秒
   - 優先度: 最新データから取得
   - 部分データでも必ず表示する

5. **エラーハンドリング改善**
   - レート制限エラーでも取得済みデータは保存・表示
   - 進捗状況の表示
   - リトライロジック

### 移行手順
1. まず200件表示問題を解決
2. ローカルキャッシュ実装
3. Convex依存コードを削除
4. 差分同期機能の追加

### 将来の拡張性
必要になったら後からConvexやSupabaseなどを追加可能な設計にする