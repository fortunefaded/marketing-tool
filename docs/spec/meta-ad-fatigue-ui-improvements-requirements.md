# Meta広告疲労度分析ダッシュボード UI/UX改善 要件定義書

## 概要

既存のMeta広告疲労度分析ダッシュボードにおいて、「集約：ON」トグルボタンを廃止し、常に集約表示をデフォルトにする。また、既存モーダル内のグラフを媒体別（Facebook/Instagram/Audience Network）の複数線表示に拡張し、Meta Ads Managerとの数値整合性を向上させる。

## ユーザストーリー

### ストーリー1: 集約表示の簡素化

- **である** マーケティング担当者 **として**
- **私は** 複雑な集約ON/OFF切り替えなしに、常に正確な集約データを確認したい **をしたい**
- **そうすることで** Meta Ads Managerとの数値一致を確認でき、データに対する信頼性が向上する

### ストーリー2: 媒体別パフォーマンス分析

- **である** 広告運用者 **として**
- **私は** Facebook、Instagram、Audience Network別の詳細なパフォーマンス推移を一つのグラフで比較確認したい **をしたい**
- **そうすることで** 媒体別の最適化戦略を効率的に立案できる

### ストーリー3: データ可視化の強化

- **である** データアナリスト **として**
- **私は** 各媒体の指標を色分けされた複数線で視覚的に把握したい **をしたい**
- **そうすることで** 媒体間の相関性や傾向を素早く理解できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは常に集約されたデータを表示しなければならない
- REQ-002: システムはクリエイティブ詳細モーダル内で媒体別グラフを表示しなければならない
- REQ-003: システムは広告費用、インプレッション、CTR、Frequency、クリック数、コンバージョンの各推移を媒体別に表示しなければならない
- REQ-004: システムは各グラフに色分けされた凡例を表示しなければならない
- REQ-005: システムは各媒体（Facebook：青線、Instagram：紫線、Audience Network：緑線）を識別可能な色で表示しなければならない
- REQ-006: システムは媒体別数値の合算が常に全体値と一致することを保証しなければならない
- REQ-007: 丸め誤差が発生する場合、システムは合計値を優先して媒体別数値を調整しなければならない

### 条件付き要件

- REQ-101: ユーザーがグラフ上の点にホバーした場合、システムは該当日付の各媒体の具体的な数値をツールチップで表示しなければならない
- REQ-102: ユーザーが媒体トグルチェックボックスを操作した場合、システムは該当媒体のグラフ線の表示/非表示を切り替えなければならない
- REQ-103: データが存在しない媒体がある場合、システムは該当する線を表示せず、凡例でグレーアウト表示しなければならない

### 状態要件

- REQ-201: システムが初期化状態にある場合、全媒体のグラフ線を表示状態で開始しなければならない
- REQ-202: モーダルが開いている状態にある場合、システムは既存の基本情報表示を維持しつつグラフのみを更新表示しなければならない

### オプション要件

- REQ-301: システムは合計値を点線または太線で追加表示してもよい
- REQ-302: システムは媒体別データをCSV形式でエクスポート機能を提供してもよい
- REQ-303: 初回アクセス時、システムは「集約ボタンが廃止され常時集約表示になった」ことを説明するワンタイムメッセージを表示してもよい

### 制約要件

- REQ-401: システムは既存モーダルの基本構造を変更してはならない
- REQ-402: システムは既存の疲労度スコア計算機能を変更してはならない
- REQ-403: システムは既存のAdDataAggregatorデータ構造との互換性を維持しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: グラフの描画処理は1秒以内に完了しなければならない
- NFR-002: 媒体トグル操作によるグラフ更新は500ms以内に完了しなければならない
- NFR-003: ツールチップの表示応答は200ms以内でなければならない

### ユーザビリティ

- NFR-201: システムは以下のアクセシビリティ要件を満たさなければならない
  - 線の種類の違い（Facebook: 実線、Instagram: 破線、Audience Network: 点線）
  - WCAG 2.1 AAレベルのコントラスト比の遵守
  - スクリーンリーダー対応のaria-label属性の実装
- NFR-202: グラフの凡例とトグルボタンは直感的に操作可能でなければならない
- NFR-203: モバイル環境でも媒体別グラフが適切に表示されなければならない

### 互換性

- NFR-301: 既存のReactコンポーネント構造と互換性を維持しなければならない
- NFR-302: TypeScriptの型安全性を維持しなければならない
- NFR-303: 既存のテストスイートに影響を与えてはならない

### データ整合性

- NFR-401: システムは媒体別データの合算値と全体値の整合性を保証しなければならない
- NFR-402: 計算精度エラーが発生した場合、システムは適切なエラーメッセージを表示しなければならない

## データ構造要件

### 現在のデータ形式
```typescript
data: [{ date: '2024-01-01', value: 1000 }]
```

### 改善後のデータ形式
```typescript
data: [{ 
  date: '2024-01-01', 
  facebook: 600, 
  instagram: 350, 
  audience_network: 50,
  total: 1000 
}]
```

## Edgeケース

### エラー処理

- EDGE-001: 特定媒体のデータが不完全な場合、システムは以下の処理を行わなければならない
  - 該当媒体のグラフ線を非表示にする
  - 凡例で「データ不足」と明示する
  - 合計値から該当媒体を除外して再計算する
  - 警告アイコンとツールチップで詳細説明を提供する
- EDGE-002: 全媒体のデータが0件の場合、システムは「データなし」メッセージを表示する
- EDGE-003: APIエラーが発生した場合、システムは既存のエラーハンドリング機構を利用する

### 境界値

- EDGE-101: 期間内のデータポイントが1件の場合、システムは単一点でのグラフを適切に表示する
- EDGE-102: 大量データ（1000ポイント以上）の場合、システムはサンプリングまたは集約による表示最適化を行う
- EDGE-103: 極端な数値（0、負数、非常に大きな値）の場合、システムは適切なスケーリングを適用する

### レスポンシブ対応

- EDGE-201: 画面幅768px未満の場合、システムは凡例を縦配置に変更する
- EDGE-202: タッチデバイスの場合、システムはタップによるツールチップ表示に対応する

## 受け入れ基準

### Phase 1（必須）：集約機能の改善

- [ ] 「集約：ON」トグルボタンが画面から削除されている
- [ ] データが常に集約された状態で表示されている
- [ ] 既存の分析機能が正常に動作している
- [ ] Meta Ads Managerとの数値が一致している

### Phase 2（グラフ拡張）：媒体別グラフ実装

- [ ] 広告費用推移グラフが媒体別（FB/IG/AN）で表示される
- [ ] インプレッション推移グラフが媒体別で表示される
- [ ] CTR推移グラフが媒体別で表示される
- [ ] Frequency推移グラフが媒体別で表示される
- [ ] クリック数推移グラフが媒体別で表示される
- [ ] コンバージョン推移グラフが媒体別で表示される

### UI/UX テスト

- [ ] 各媒体が指定された色（FB：青、IG：紫、AN：緑）で表示される
- [ ] 凡例が適切に表示され、色と媒体名が対応している
- [ ] 媒体トグルチェックボックスが正常に機能する
- [ ] ツールチップが正確な数値を表示する
- [ ] モバイル環境での表示が適切である

### パフォーマンステスト

- [ ] グラフ描画が1秒以内に完了する
- [ ] 媒体トグル操作が500ms以内に応答する
- [ ] ツールチップ表示が200ms以内に応答する

### 互換性テスト

- [ ] 既存モーダルの基本機能が影響を受けない
- [ ] 疲労度スコア計算が正常に動作する
- [ ] 既存テストスイートが通過する
- [ ] TypeScriptコンパイルエラーが発生しない

### データ整合性テスト

- [ ] 媒体別数値の合算が全体値と一致する
- [ ] 丸め誤差処理が正常に動作する
- [ ] データ不足時の警告表示が適切である
- [ ] アクセシビリティ要件（WCAG 2.1 AA）を満たす

## 実装フェーズ

### Phase 0: 事前準備（1日）
- 既存テストスイートの実行と基準値記録
- AdDataAggregatorのデータ構造確認
- 現在の集約機能の動作検証

### Phase 1: 集約機能簡素化（1日・必須）
- 集約トグルボタンの削除
- enableAggregationのデフォルトtrue化
- 常時集約モードでの動作確認
- 既存機能への影響確認

### Phase 2: グラフ拡張（3-4日・主要機能）
- グラフコンポーネントの媒体別対応
- データ構造の変換ロジック実装
- 凡例とトグル機能の実装
- ツールチップ機能の実装
- データ整合性チェック機能の追加

### Phase 3: 最適化（オプション）
- パフォーマンスチューニング
- アクセシビリティ向上
- 追加機能（CSV エクスポート、ワンタイムメッセージ等）

## 成功指標

### 定量指標
- 集約機能に関する問い合わせ数：50%減少
- 媒体別パフォーマンス把握時間：30%短縮
- Meta Ads Managerとの数値一致率：100%達成

### 定性指標
- ユーザー操作の直感性向上
- データ信頼性の向上
- 分析効率の改善

## 開発者向けガイドライン

### 技術仕様

- **グラフライブラリ**: 既存のRecharts または Chart.js を継続使用
- **カラーコード**: 
  - Facebook: `#1877F2` (青)
  - Instagram: `#E4405F` (紫/ピンク)
  - Audience Network: `#42B883` (緑)
- **データ変換**: 既存の `AdDataAggregator` メソッドを拡張して媒体別データ形式に対応

### 実装方針

- 既存のコンポーネント構造を最大限活用
- 型安全性を維持しながら段階的に拡張
- パフォーマンス劣化を避けるため、メモ化とレイジーローディングを適用

### コードレビューポイント

- データ整合性チェック機能の実装確認
- アクセシビリティ属性の適切な設定
- レスポンシブデザインの動作検証
- エラーハンドリングの網羅性確認

## 注意事項

- 既存のAdDataAggregatorは既に媒体別データを保持しているため、主にフロントエンド側の表示ロジックの変更となる
- 現在のモーダル構造を維持することで、実装リスクを最小化する
- 段階的実装により、各フェーズでのリグレッションテストを実施する