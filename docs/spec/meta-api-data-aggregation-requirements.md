# Meta API データ集約と時系列管理 要件定義書

## 概要

Meta広告APIから取得したデータの重複問題を解決し、時系列データの適切な管理と疲労度分析機能を実装する。現在、プラットフォーム別・日別のブレークダウンにより1つの広告が最大90行（3プラットフォーム×30日）に分割される問題が発生しており、これを階層的データ構造で解決する。

## ユーザストーリー

### ストーリー1: 広告パフォーマンスの統合表示
- **である** マーケティング担当者 **として**
- **私は** 同じ広告のデータが1行に集約された状態で確認 **をしたい**
- **そうすることで** 広告単位のパフォーマンスを即座に把握できる

### ストーリー2: 時系列トレンド分析
- **である** マーケティング担当者 **として**
- **私は** 日別のパフォーマンス推移を確認 **をしたい**
- **そうすることで** 広告疲労の兆候を早期に発見できる

### ストーリー3: プラットフォーム別分析
- **である** マーケティング担当者 **として**
- **私は** 必要に応じてプラットフォーム別の詳細データを確認 **をしたい**
- **そうすることで** プラットフォーム固有の最適化戦略を立案できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは、同一ad_idのすべての行を1つのAdPerformanceDataオブジェクトに集約しなければならない
- REQ-002: システムは、日別・プラットフォーム別のデータを階層構造で保持しなければならない
- REQ-003: システムは、期間全体のサマリーメトリクスを自動計算しなければならない
- REQ-004: システムは、数値メトリクス（impressions, clicks, spend）を合計値として集計しなければならない
- REQ-005: システムは、比率メトリクス（CTR, CPM, CPC）を再計算しなければならない
- REQ-006: システムは、reachメトリクスについて最大値を採用しなければならない

### 条件付き要件

- REQ-101: データにplatform情報が含まれる場合、システムはplatformBreakdownオブジェクトを作成しなければならない
- REQ-102: 日別データが利用可能な場合、システムはdailyBreakdown配列を作成しなければならない
- REQ-103: 7日以上のデータが存在する場合、システムは移動平均を計算しなければならない
- REQ-104: conversionデータが存在する場合、システムはROASを計算しなければならない
- REQ-105: frequencyが3.5を超える場合、システムは疲労度statusを"warning"以上に設定しなければならない
- REQ-106: CTRがベースラインから25%以上低下した場合、システムは疲労度statusを"critical"に設定しなければならない

### 状態要件

- REQ-201: データ取得中の状態にある場合、システムは進捗状況を表示しなければならない
- REQ-202: データが30日分存在する状態の場合、システムは期間選択（7d/14d/30d）を有効にしなければならない
- REQ-203: エラー状態にある場合、システムは最後に成功したデータを保持しなければならない

### オプション要件

- REQ-301: システムは、疲労度の予測値を最大7日先まで計算してもよい
- REQ-302: システムは、プラットフォーム別のデータを個別のグラフで表示してもよい
- REQ-303: システムは、異常値を自動検出してハイライトしてもよい
- REQ-304: システムは、Web Workerを使用してバックグラウンドで集計処理を実行してもよい

### 制約要件

- REQ-401: システムは、最大1000広告×30日×3プラットフォームのデータを処理できなければならない
- REQ-402: システムは、データ集約処理を3秒以内に完了しなければならない
- REQ-403: システムは、既存のAdInsight型との後方互換性を維持しなければならない
- REQ-404: システムは、不完全なデータ（欠損値）を適切に処理しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: 90,000行（1000広告×30日×3プラットフォーム）のデータ集約を3秒以内に完了すること
- NFR-002: UIの応答性を保つため、100ms以上かかる処理は非同期で実行すること
- NFR-003: メモリ使用量は500MB以下に抑えること
- NFR-004: useMemoによる適切なメモ化を実装し、不要な再計算を防ぐこと

### 信頼性

- NFR-101: 部分的なデータ欠損があっても集計処理を継続すること
- NFR-102: API接続エラー時は、ローカルキャッシュから最新データを表示すること
- NFR-103: データ不整合を検出した場合、警告を表示しつつ処理を継続すること

### ユーザビリティ

- NFR-201: データ集約状況を進捗バーまたはスピナーで表示すること
- NFR-202: 重複解消前後のデータ件数を明示すること
- NFR-203: 期間切り替えは即座に反映され、再取得は不要であること
- NFR-204: エラーメッセージは具体的な対処法を含むこと

### 保守性

- NFR-301: 新しいプラットフォームやメトリクスの追加が容易な設計とすること
- NFR-302: デバッグログを適切に出力し、問題の特定を容易にすること
- NFR-303: TypeScriptの型定義を完全に行い、型安全性を確保すること

## Edgeケース

### データ不整合

- EDGE-001: 同一ad_idで日付が重複している場合、最新のデータを優先する
- EDGE-002: プラットフォーム名が未知の値の場合、"other"として集計する
- EDGE-003: 負の数値が含まれる場合、0として扱いログに警告を出力する

### 境界値

- EDGE-101: 0件のデータの場合、空配列を返し、UIに「データなし」を表示する
- EDGE-102: 1日分のデータしかない場合、トレンド計算をスキップする
- EDGE-103: frequencyが100を超える場合、異常値として別途フラグを立てる
- EDGE-104: CTRが100%の場合、データ異常の可能性を警告する

### パフォーマンス限界

- EDGE-201: 10万行を超えるデータの場合、バッチ処理に切り替える
- EDGE-202: メモリ使用量が閾値を超えた場合、古いデータを自動的に破棄する
- EDGE-203: 処理時間が10秒を超えた場合、タイムアウトエラーとする

### API関連

- EDGE-301: APIレート制限に達した場合、指数バックオフで再試行する
- EDGE-302: 部分的なデータ欠損の場合、取得できた範囲で集計を実行する
- EDGE-303: タイムアウトの場合、より小さい期間で再取得を試みる

## 受け入れ基準

### 機能テスト

#### データ集約
- [ ] 同一ad_idの複数行が1つのAdPerformanceDataオブジェクトに集約される
- [ ] 日別データがdailyBreakdown配列に正しく格納される
- [ ] プラットフォーム別データがplatformBreakdownに正しく格納される
- [ ] 期間サマリーが正確に計算される
- [ ] 数値メトリクスの合計が元データと一致する
- [ ] 比率メトリクスが正しく再計算される
- [ ] reachの最大値が正しく選択される

#### 疲労度計算
- [ ] CTR低下率が正確に計算される
- [ ] frequency閾値による判定が正しく動作する
- [ ] 疲労度スコアが0-100の範囲内である
- [ ] 時系列の疲労度推移が計算される
- [ ] 7日間移動平均が正しく計算される

#### UI表示
- [ ] 集約後のデータが1行で表示される
- [ ] 期間選択（7d/14d/30d）が正しく動作する
- [ ] 日別グラフが表示される
- [ ] プラットフォーム別表示の切り替えが動作する
- [ ] 進捗インジケーターが表示される

### 非機能テスト

#### パフォーマンス
- [ ] 1000広告のデータ処理が3秒以内に完了する
- [ ] UIがフリーズしない（非同期処理）
- [ ] メモリリークが発生しない
- [ ] スクロールがスムーズである

#### エラーハンドリング
- [ ] 不完全なデータでもエラーにならない
- [ ] APIエラー時に適切なメッセージが表示される
- [ ] データ不整合の警告が表示される
- [ ] ゼロ除算エラーが発生しない

#### 互換性
- [ ] 既存のAdInsight型を使用したコードが動作する
- [ ] 既存のUIコンポーネントとの統合が問題ない
- [ ] データマイグレーションが不要である

## 実装チェックリスト

### Phase 1: データ構造とアグリゲーター（2-3日）
- [ ] AdPerformanceData型定義の作成
- [ ] AdDataAggregatorクラスの実装
- [ ] 単体テストの作成
- [ ] 集約ロジックの最適化

### Phase 2: 既存コードとの統合（1-2日）
- [ ] useMetaApiFetcherの修正
- [ ] 後方互換性の確保
- [ ] 統合テストの実施
- [ ] デバッグログの追加

### Phase 3: 疲労度計算の拡張（2日）
- [ ] FatigueTimelineCalculatorの実装
- [ ] 時系列分析ロジックの実装
- [ ] 予測アルゴリズムの実装（オプション）
- [ ] パフォーマンステスト

### Phase 4: UI実装（2-3日）
- [ ] 期間選択UIの追加
- [ ] グラフコンポーネントの実装
- [ ] プラットフォーム別表示の実装
- [ ] 進捗表示の実装

### Phase 5: テストと最適化（1-2日）
- [ ] E2Eテストの実施
- [ ] パフォーマンスプロファイリング
- [ ] メモリ使用量の最適化
- [ ] ドキュメントの作成

## 依存関係

### 技術的依存
- React 18+
- TypeScript 5+
- Meta Marketing API v23.0
- Convex（データストレージ）

### 内部依存
- SimpleFatigueCalculator
- MetaAccountManager
- ConvexDataCache

### 外部依存
- Meta API レート制限（200リクエスト/時）
- ブラウザメモリ制限

## リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 大量データによるメモリ不足 | 高 | 中 | ページネーション、遅延読み込み |
| API レート制限 | 高 | 低 | キャッシュ戦略、バッチ処理 |
| ブラウザのフリーズ | 高 | 低 | Web Worker、非同期処理 |
| データ不整合 | 中 | 中 | バリデーション、エラーログ |
| 後方互換性の破壊 | 高 | 低 | アダプターパターン、段階的移行 |

## 成功指標

- データ重複が100%解消される
- 広告一覧の表示速度が50%向上
- 疲労度検出精度が80%以上
- ユーザーからの重複データに関する問い合わせがゼロになる
- 日別トレンド分析機能の利用率が70%以上

---

作成日: 2025-08-27
作成者: Claude Code
バージョン: 1.0.0