# 3層キャッシュシステム移行 要件定義書

## 概要

既存の広告疲労度分析ダッシュボード（http://localhost:3000/ad-fatigue）のデータ取得機構を、パフォーマンスと信頼性を向上させるため、3層キャッシュアーキテクチャに移行する。この移行により、Meta API のレート制限を遵守しながら、ユーザー体験を大幅に改善する。

## 背景と課題

### 現状の問題点
- Meta API への直接アクセスによるレスポンス遅延（~1000ms）
- レート制限（200req/h, 4800req/day）によるサービス停止リスク
- ページリロード時の不要なAPI呼び出し
- 複数ユーザー間でのデータ共有不可
- オフライン時のデータアクセス不可

### 期待される改善
- レスポンス時間の短縮（L1: ~10ms, L2: ~100ms）
- API呼び出し回数の最適化
- リアルタイムデータ同期
- オフライン対応

## ユーザストーリー

### ストーリー1: 高速なダッシュボード表示

- **である** マーケティング担当者 **として**
- **私は** 広告疲労度ダッシュボードを瞬時に表示 **したい**
- **そうすることで** 迅速な意思決定ができる

### ストーリー2: リアルタイムデータ同期

- **である** チームメンバー **として**
- **私は** 他のメンバーと同じデータを見たい
- **そうすることで** チーム全体で一貫した分析ができる

### ストーリー3: API制限の回避

- **である** システム管理者 **として**
- **私は** Meta APIのレート制限を超えないようにしたい
- **そうすることで** サービスの安定性を維持できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは3層キャッシュ（L1:メモリ、L2:Convex、L3:Meta API）を実装しなければならない
- REQ-002: システムは上位層から順にデータを検索し、最初にヒットしたデータを返さなければならない
- REQ-003: システムはL3から取得したデータを自動的にL1とL2に保存しなければならない
- REQ-004: システムは既存のFatigueDashboardContainerの機能を完全に維持しなければならない
- REQ-005: システムは広告疲労度スコア（0-100）を計算して表示しなければならない

### 条件付き要件

- REQ-101: L1キャッシュにデータが存在する場合、システムは10ms以内にデータを返さなければならない
- REQ-102: L2キャッシュにデータが存在する場合、システムは100ms以内にデータを返さなければならない
- REQ-103: キャッシュにデータが存在しない場合、システムはMeta APIから最新データを取得しなければならない
- REQ-104: アクセストークンが未設定の場合、システムはエラーメッセージを表示しなければならない
- REQ-105: API呼び出しが失敗した場合、システムは利用可能な最新のキャッシュデータを返さなければならない

### 状態要件

- REQ-201: オフライン状態にある場合、システムはL1およびL2キャッシュのみを使用しなければならない
- REQ-202: レート制限に達している場合、システムはキャッシュデータのみを使用しなければならない
- REQ-203: トークンが期限切れの場合、システムは再認証を促さなければならない

### オプション要件

- REQ-301: システムはキャッシュヒット率の統計を表示してもよい
- REQ-302: システムは各キャッシュ層のレイテンシを表示してもよい
- REQ-303: システムはデータの鮮度スコアを表示してもよい
- REQ-304: システムは手動でキャッシュをクリアする機能を提供してもよい

### 制約要件

- REQ-401: システムはMeta Graph API v23.0を使用しなければならない
- REQ-402: システムはレート制限（200req/h, 4800req/day）を超えてはならない
- REQ-403: L1キャッシュは50MB以下のメモリ使用量でなければならない
- REQ-404: L2キャッシュはConvexデータベースを使用しなければならない
- REQ-405: システムは既存のUIコンポーネントを変更してはならない

## 非機能要件

### パフォーマンス

- NFR-001: キャッシュヒット時のレスポンス時間はL1で10ms以下、L2で100ms以下でなければならない
- NFR-002: 初回ロード時でも3秒以内にダッシュボードを表示しなければならない
- NFR-003: 1000件のデータポイントを5秒以内に処理できなければならない

### セキュリティ

- NFR-101: アクセストークンはメモリ内でのみ保持し、LocalStorageには保存してはならない
- NFR-102: APIレスポンスは適切にサニタイズしなければならない
- NFR-103: キャッシュデータへのアクセスは認証済みユーザーに限定しなければならない

### ユーザビリティ

- NFR-201: データ取得中はローディングインジケーターを表示しなければならない
- NFR-202: どのキャッシュ層からデータを取得したか視覚的に表示しなければならない
- NFR-203: エラー発生時は分かりやすいエラーメッセージを表示しなければならない

### 信頼性

- NFR-301: システムは99.9%の可用性を維持しなければならない
- NFR-302: キャッシュ障害時でもAPIから直接データ取得できなければならない
- NFR-303: データの整合性を保証しなければならない

## Edgeケース

### エラー処理

- EDGE-001: Meta APIがダウンしている場合、最新のキャッシュデータを使用し、警告を表示する
- EDGE-002: Convexデータベースが利用不可の場合、L1とL3のみで動作を継続する
- EDGE-003: アクセストークンが無効な場合、再認証フローを開始する
- EDGE-004: ネットワークエラーの場合、3回までリトライし、指数バックオフを適用する

### 境界値

- EDGE-101: キャッシュサイズが上限に達した場合、LRUアルゴリズムで古いデータを削除する
- EDGE-102: 0件のデータが返された場合、適切なメッセージを表示する
- EDGE-103: 10,000件以上のデータがある場合、ページネーションを使用する
- EDGE-104: TTLが期限切れの場合、バックグラウンドで更新を開始する

### 同期処理

- EDGE-201: 複数ユーザーが同時に同じデータを更新した場合、最新のタイムスタンプを優先する
- EDGE-202: WebSocket接続が切断された場合、自動的に再接続を試みる
- EDGE-203: 部分的なデータ更新の場合、差分のみを同期する

## 移行計画

### フェーズ1: 基盤実装（完了）
- [x] ThreeLayerCacheクラスの実装
- [x] MemoryCacheの実装
- [x] Convex統合
- [x] テストページの作成

### フェーズ2: API統合（進行中）
- [x] Meta API v23.0エンドポイント実装
- [x] アクセストークン管理
- [ ] エラーハンドリング
- [ ] レート制限対策

### フェーズ3: ダッシュボード統合
- [ ] FatigueDashboardContainerの改修
- [ ] データ変換ロジック
- [ ] 疲労度スコア計算
- [ ] UI更新

### フェーズ4: 最適化
- [ ] パフォーマンスチューニング
- [ ] キャッシュ戦略の最適化
- [ ] モニタリング実装

## 受け入れ基準

### 機能テスト

- [ ] 3層キャッシュが正しく動作すること
- [ ] 既存の全機能が維持されていること
- [ ] 広告疲労度スコアが正しく計算されること
- [ ] データ更新ボタンが機能すること
- [ ] アカウント切り替えが正しく動作すること
- [ ] 日付範囲の変更が反映されること
- [ ] フィルター機能が維持されていること

### パフォーマンステスト

- [ ] L1キャッシュヒット時のレスポンスが10ms以下
- [ ] L2キャッシュヒット時のレスポンスが100ms以下
- [ ] 初回ロードが3秒以内
- [ ] メモリ使用量が50MB以下

### 統合テスト

- [ ] /meta-api-setupで設定したアカウントが使用できること
- [ ] Convexとの同期が正しく動作すること
- [ ] 複数ユーザー間でデータが共有されること
- [ ] オフライン時でもキャッシュデータが表示されること

### セキュリティテスト

- [ ] アクセストークンがLocalStorageに保存されていないこと
- [ ] 認証なしでキャッシュデータにアクセスできないこと
- [ ] XSS攻撃に対する防御が機能すること

### エラーハンドリングテスト

- [ ] API障害時にキャッシュフォールバックが動作すること
- [ ] レート制限エラーが適切に処理されること
- [ ] ネットワークエラー時のリトライが動作すること
- [ ] エラーメッセージが適切に表示されること

## 成功指標

- レスポンス時間が90%以上改善される
- API呼び出し回数が70%以上削減される
- ユーザー満足度スコアが向上する
- システムダウンタイムがゼロになる

## リスクと対策

| リスク | 影響度 | 発生確率 | 対策 |
|--------|--------|----------|------|
| 既存機能の破壊 | 高 | 中 | 段階的移行、十分なテスト |
| データ不整合 | 高 | 低 | トランザクション処理、検証ロジック |
| パフォーマンス劣化 | 中 | 低 | プロファイリング、最適化 |
| 移行期間の長期化 | 中 | 中 | 明確なマイルストーン設定 |

## 付録

### 用語集

- **L1キャッシュ**: メモリ内キャッシュ、最速だが揮発性
- **L2キャッシュ**: Convexデータベース、永続化とリアルタイム同期
- **L3**: Meta API、最新データの取得元
- **TTL**: Time To Live、キャッシュの有効期限
- **LRU**: Least Recently Used、キャッシュ削除アルゴリズム
- **疲労度スコア**: CTR低下率、Frequency、CPM上昇率から算出される0-100の指標

### 関連文書

- CLAUDE.md: プロジェクト全体の開発指針
- /src/features/meta-api/core/three-layer-cache.ts: 実装コード
- /src/pages/ThreeLayerCacheTestPage.tsx: テストページ

---

作成日: 2025-09-02
バージョン: 1.0.0
作成者: Claude Code Assistant