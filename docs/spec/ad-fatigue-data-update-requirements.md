# 広告疲労度データ更新機能 要件定義書

## 概要

広告疲労度ダッシュボード（/ad-fatigue）において、データ更新ボタンが正常に動作し、最新のMeta広告データを取得・表示できる機能を実装する。現在のユーザビリティ問題を解決し、リアルタイムでのデータ監視を可能にする。

## ユーザストーリー

### ストーリー1: データの即座更新

- **であるマーケター として**
- **私は** 広告疲労度データ更新ボタンをクリックして最新データを取得したい
- **そうすることで** リアルタイムの広告パフォーマンスを正確に監視し、適切なタイミングで広告最適化判断ができる

### ストーリー2: 更新状況の可視化

- **であるマーケター として**
- **私は** データ更新処理の進行状況を視覚的に確認したい
- **そうすることで** 処理完了まで安心して待機でき、システムが正常に動作していることを確認できる

### ストーリー3: エラー状況の理解

- **であるマーケター として**
- **私は** データ更新が失敗した理由を分かりやすく知りたい
- **そうすることで** 問題を迅速に解決し、業務を継続できる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは「データ更新」ボタンをダッシュボード右上に表示しなければならない
- REQ-002: システムは更新ボタンクリック時に最新のMeta API データを取得しなければならない
- REQ-003: システムは取得したデータから広告疲労度スコアを再計算しなければならない
- REQ-004: システムは更新完了後にダッシュボード表示を新しいデータで更新しなければならない
- REQ-005: システムはデータソース（キャッシュ/API）を明示的に表示しなければならない

### 条件付き要件

- REQ-101: 更新処理実行中の場合、システムは更新ボタンを無効化しなければならない
- REQ-102: アクセストークンが無効な場合、システムはトークン再設定へのリンクを表示しなければならない
- REQ-103: API リクエストが失敗した場合、システムはキャッシュデータにフォールバックしてもよい
- REQ-104: ネットワークエラーが発生した場合、システムは再試行オプションを提供しなければならない
- REQ-105: 広告アカウントが選択されていない場合、システムは更新ボタンを非表示にしなければならない

### 状態要件

- REQ-201: データ取得中の状態にある場合、システムはローディングインジケーターを表示しなければならない
- REQ-202: エラー状態にある場合、システムは具体的なエラーメッセージとアクションを表示しなければならない
- REQ-203: データが正常に更新された状態にある場合、システムは成功メッセージを一時的に表示してもよい

### オプション要件

- REQ-301: システムは自動更新間隔設定機能を提供してもよい
- REQ-302: システムはデータ更新履歴を表示してもよい
- REQ-303: システムは更新完了時に音声通知を提供してもよい

### 制約要件

- REQ-401: システムは Meta API レート制限（200リクエスト/時間）を遵守しなければならない
- REQ-402: システムは同時実行される更新リクエストを1つに制限しなければならない
- REQ-403: システムは更新処理のタイムアウトを30秒に設定しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: データ更新処理は30秒以内に完了しなければならない
- NFR-002: UI応答性は更新処理中も100ms以下を維持しなければならない
- NFR-003: 取得したデータはローカルキャッシュに保存し、次回アクセス時の高速化を図らなければならない

### セキュリティ

- NFR-101: アクセストークンは安全な方法でConvexに保存され、クライアントサイドに露出してはならない
- NFR-102: API リクエストは HTTPS プロトコルを使用しなければならない
- NFR-103: エラーメッセージにセンシティブな情報を含めてはならない

### ユーザビリティ

- NFR-201: 更新ボタンは視覚的に分かりやすく、アクセスしやすい位置に配置しなければならない
- NFR-202: 進行状況はプログレスバーまたはスピナーで明確に表示しなければならない
- NFR-203: エラーメッセージは日本語で分かりやすく表示しなければならない

### 可用性

- NFR-301: システムはMeta API障害時もキャッシュデータで継続運用できなければならない
- NFR-302: 部分的なデータ取得失敗時も取得できたデータを表示しなければならない

## Edgeケース

### エラー処理

- EDGE-001: Meta API がメンテナンス中の場合、適切なメッセージを表示し、キャッシュデータで運用する
- EDGE-002: トークンの有効期限切れの場合、再認証フローへ誘導する
- EDGE-003: 広告アカウントアクセス権限が失効した場合、権限確認を促す
- EDGE-004: 不正なレスポンスデータの場合、データ検証エラーとして処理する

### 境界値

- EDGE-101: 広告数が0件の場合、「データなし」メッセージを表示する  
- EDGE-102: API レスポンスが異常に大きい場合（>1000件）、分割処理を行う
- EDGE-103: ネットワーク速度が著しく遅い場合、タイムアウト時間を延長する

### 同時実行

- EDGE-201: 複数タブで同時更新実行時、最初のリクエストのみ処理し、他は待機状態にする
- EDGE-202: 更新処理中のページリロード時、進行中の処理を適切に中断する

## 受け入れ基準

### 機能テスト

- [ ] 更新ボタンクリックで最新データが取得できること
- [ ] 更新処理中はボタンが無効化されること
- [ ] データソースが正しく表示されること
- [ ] エラー時に適切なメッセージが表示されること
- [ ] アカウント未選択時はボタンが非表示になること
- [ ] 取得したデータから疲労度スコアが正しく計算されること
- [ ] 統計カード（Total, Critical, Warning, Healthy）が正しく更新されること

### 非機能テスト

- [ ] 30秒以内にデータ更新が完了すること
- [ ] 更新処理中もUI操作が可能であること
- [ ] Meta API レート制限を遵守すること
- [ ] HTTPS通信が使用されること
- [ ] エラーメッセージにトークン等の機密情報が含まれないこと

### 統合テスト

- [ ] Convexとの連携が正常に動作すること
- [ ] useAdFatigue フックが正しくデータを返すこと
- [ ] SimpleFatigueCalculator による計算が正確であること
- [ ] アカウント変更時にデータが適切に切り替わること

### ユーザビリティテスト

- [ ] マーケターが直感的に更新ボタンを見つけられること
- [ ] 進行状況が分かりやすく表示されること
- [ ] エラーメッセージから解決方法が理解できること