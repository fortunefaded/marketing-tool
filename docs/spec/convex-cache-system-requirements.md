# Convexベースキャッシュシステム 要件定義書

## 概要

現在の/ad-fatigueページにおけるデータ不整合問題を解決するため、Convexデータベースを活用した永続化キャッシュシステムを実装する。本システムにより、データの一貫性確保、API使用量削減（90%）、応答速度向上（5秒→1秒）を実現する。

## ユーザストーリー

### ストーリー1: データ一貫性の確保

- **である** マーケティング担当者 **として**
- **私は** ページをリロードしても同じ広告クリエイティブ数が表示される **ことを望む**
- **そうすることで** 正確な広告疲労度分析を実施し、適切な意思決定を行うことができる

### ストーリー2: 高速なデータアクセス

- **である** システム利用者 **として**
- **私は** 広告パフォーマンスデータを3秒以内で表示したい **と思う**
- **そうすることで** 効率的な分析作業を継続できる

### ストーリー3: コスト効率的なAPI利用

- **である** システム管理者 **として**
- **私は** Meta API呼び出し回数を最小限に抑えたい **と考える**
- **そうすることで** 運用コストを削減し、レート制限を回避できる

### ストーリー4: リアルタイム同期

- **である** チームメンバー **として**
- **私は** 他のユーザーが更新したデータをリアルタイムで確認したい **と思う**
- **そうすることで** 全員が同じデータに基づいて作業できる

## 機能要件（EARS記法）

### 通常要件

- **REQ-001**: システムは広告パフォーマンスデータをConvexデータベースに永続化しなければならない
- **REQ-002**: システムはアカウントID × 日付 × 広告IDの複合キーでデータの一意性を保証しなければならない
- **REQ-003**: システムは3層キャッシュ（メモリ・Convex・Meta API）を実装しなければならない
- **REQ-004**: システムはupsert戦略によりデータ重複を防止しなければならない
- **REQ-005**: システムはWebSocketベースのリアルタイム同期を提供しなければならない

### 条件付き要件

- **REQ-101**: データが3日以上前の場合、システムは更新処理をスキップしなければならない
- **REQ-102**: データが当日の場合、システムは3時間毎に更新チェックを実行しなければならない
- **REQ-103**: データが1-2日前の場合、システムは6時間毎に更新チェックを実行しなければならない
- **REQ-104**: データが2-3日前の場合、システムは1日1回更新チェックを実行しなければならない
- **REQ-105**: キャッシュミスが発生した場合、システムは自動的に上位層にフォールバックしなければならない
- **REQ-106**: API レート制限エラーが発生した場合、システムは指数バックオフを適用しなければならない
- **REQ-107**: ネットワークエラーが発生した場合、システムは最大3回まで自動リトライしなければならない

### 状態要件

- **REQ-201**: システムがオフライン状態の場合、キャッシュされたデータを表示しなければならない
- **REQ-202**: システムが復旧状態の場合、自動的にデータ同期を開始しなければならない
- **REQ-203**: データが「finalized」状態の場合、更新処理を実行してはならない
- **REQ-204**: データが「realtime」状態の場合、高頻度更新を実行しなければならない

### オプション要件

- **REQ-301**: システムは予測的データプリフェッチングを実装してもよい
- **REQ-302**: システムはユーザーアクセスパターンに基づく最適化を行ってもよい
- **REQ-303**: システムは休日・イベント期間に特別な更新ルールを適用してもよい

### 制約要件

- **REQ-401**: システムはキャッシュヒット率95%以上を維持しなければならない
- **REQ-402**: システムはMeta API呼び出しを90%以上削減しなければならない
- **REQ-403**: システムはメモリ使用量をタブあたり50MB以下に制限しなければならない
- **REQ-404**: システムは最大10アカウントの並行処理に対応しなければならない

## 非機能要件

### パフォーマンス

- **NFR-001**: キャッシュヒット時の応答時間は100ms以下でなければならない（P95パーセンタイル）
- **NFR-002**: 差分更新完了時間は5秒以下でなければならない（3日分のデータ）
- **NFR-003**: 初回ロード時間は3秒以下でなければならない（コールドスタート）
- **NFR-004**: リアルタイム同期の遅延は100ms以下でなければならない

### データ品質

- **NFR-101**: データ整合性は100%を維持しなければならない
- **NFR-102**: データ重複率は0%でなければならない
- **NFR-103**: データ欠損率は0.1%以下でなければならない
- **NFR-104**: 当日データの更新遅延は3時間以内でなければならない

### 可用性

- **NFR-201**: システムは99.9%以上の稼働率を維持しなければならない
- **NFR-202**: 自動復旧機能により手動介入を不要にしなければならない
- **NFR-203**: バックアップは日次で自動実行されなければならない

### セキュリティ

- **NFR-301**: Meta API認証トークンは暗号化して保存しなければならない
- **NFR-302**: データアクセスはアカウント単位で制御されなければならない
- **NFR-303**: ログは30日間保持し、監査可能でなければならない

### ユーザビリティ

- **NFR-401**: データ更新状況はリアルタイムで表示されなければならない
- **NFR-402**: エラー発生時は明確なメッセージを表示しなければならない
- **NFR-403**: オフライン状態は視覚的に示されなければならない

## Edgeケース

### エラー処理

- **EDGE-001**: Convex接続失敗時はローカルキャッシュにフォールバック
- **EDGE-002**: Meta API認証エラー時は管理者に自動通知
- **EDGE-003**: データ破損検出時は自動的にバックアップから復元
- **EDGE-004**: スキーマ変更時は下位互換性を維持
- **EDGE-005**: メモリ不足時は古いキャッシュエントリを自動削除

### 境界値

- **EDGE-101**: 日付範囲が1日の場合でも差分更新ロジックを適用
- **EDGE-102**: データサイズが10MB以上の場合はチャンク処理を実行
- **EDGE-103**: 同時接続数が上限に達した場合は接続を待機列に追加
- **EDGE-104**: API レスポンスが30秒を超える場合はタイムアウト
- **EDGE-105**: キャッシュサイズが制限に達した場合はLRU方式で削除

### データ整合性

- **EDGE-201**: タイムゾーンが異なる場合は UTC で正規化
- **EDGE-202**: サマータイム切り替え時は時刻補正を実行
- **EDGE-203**: 広告IDの重複が検出された場合は最新データを優先
- **EDGE-204**: 小数点精度の違いがある場合は標準化

### 運用系

- **EDGE-301**: ストレージ容量が90%を超えた場合は古いデータを自動削除
- **EDGE-302**: CPU使用率が80%を超えた場合は更新頻度を一時的に削減
- **EDGE-303**: ネットワーク帯域が制限された場合は圧縮転送を実行

## 受け入れ基準

### 機能テスト

- [ ] **AC-001**: ページリロード後も同じ広告数が表示される
- [ ] **AC-002**: 複数タブで同じデータが表示される
- [ ] **AC-003**: 日付範囲変更時に適切な差分更新が実行される
- [ ] **AC-004**: オフライン時でもキャッシュデータが表示される
- [ ] **AC-005**: API エラー時に自動リトライが実行される
- [ ] **AC-006**: データ更新時に全クライアントが即座に同期される
- [ ] **AC-007**: 古いデータは自動的に更新対象から除外される
- [ ] **AC-008**: 重複データが挿入されない

### 非機能テスト

- [ ] **AC-101**: キャッシュヒット時の応答時間が100ms以下である
- [ ] **AC-102**: 30日間の連続運用でデータ不整合が発生しない
- [ ] **AC-103**: API 呼び出し数が従来比90%削減されている
- [ ] **AC-104**: メモリ使用量がタブあたり50MB以下である
- [ ] **AC-105**: 10アカウント同時処理でも性能低下しない
- [ ] **AC-106**: ネットワーク障害から30秒以内に復旧する
- [ ] **AC-107**: 大量データ（10万件）処理で5秒以内に完了する
- [ ] **AC-108**: 24時間連続稼働で メモリリークが発生しない

### 統合テスト

- [ ] **AC-201**: 既存のuseAdFatigueフックが変更なしで動作する
- [ ] **AC-202**: 既存のuseMetaInsightsフックが変更なしで動作する
- [ ] **AC-203**: FatigueDashboardコンポーネントが正常に動作する
- [ ] **AC-204**: Meta API認証が既存システムと連携する
- [ ] **AC-205**: Convexスキーマ拡張が既存データと互換性を持つ

### セキュリティテスト

- [ ] **AC-301**: 認証されていないユーザーがデータにアクセスできない
- [ ] **AC-302**: 他アカウントのデータが取得できない
- [ ] **AC-303**: APIトークンが平文で保存されていない
- [ ] **AC-304**: ログに機密情報が出力されていない

### 運用テスト

- [ ] **AC-401**: エラー発生時にSlack通知が送信される
- [ ] **AC-402**: Convexダッシュボードで監視メトリクスが確認できる
- [ ] **AC-403**: 日次バックアップが自動実行される
- [ ] **AC-404**: ログローテーションが30日で実行される
- [ ] **AC-405**: システム復旧が手動介入なしで完了する

## 実装マイルストーン

### Week 1: コア機能
- [ ] Convexキャッシュレイヤー実装
- [ ] 基本的な差分更新ロジック
- [ ] 既存フックとの統合

### Week 2: 最適化
- [ ] スケジューラー設定
- [ ] 更新ルールエンジン
- [ ] パフォーマンスチューニング

### Week 3: 品質保証
- [ ] 統合テスト実行
- [ ] 負荷テスト実行
- [ ] 本番環境デプロイ

## 成功指標（KPI）

- **データ不整合発生率**: 0%（現状: 100%）
- **平均ページロード時間**: < 3秒（現状: 5-10秒）
- **Meta API呼び出し削減率**: 90%以上
- **キャッシュヒット率**: 95%以上
- **自動化率**: 100%（手動介入なし）

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| Convex制限超過 | 高 | 使用量モニタリング・アラート設定 |
| Meta API仕様変更 | 中 | APIバージョン固定・変更監視 |
| 差分ロジックバグ | 中 | 日次照合・自動修復機能 |
| パフォーマンス劣化 | 低 | 継続的監視・最適化 |