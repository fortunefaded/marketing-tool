# 日付範囲フィルター機能 要件定義書

## 概要

Meta広告の疲労度ダッシュボードにおいて、ユーザーが指定した期間のデータを取得・表示する機能。これにより、マーケターは特定期間の広告パフォーマンスを分析し、適切な最適化判断を行うことができる。

## ユーザストーリー

### ストーリー1: 期間別パフォーマンス分析

- **である** マーケティング担当者 **として**
- **私は** 異なる期間の広告パフォーマンスを比較 **したい**
- **そうすることで** 時系列での疲労度の変化を把握し、最適な広告更新タイミングを判断できる

### ストーリー2: 直近データの確認

- **である** 広告運用担当者 **として**
- **私は** 昨日の広告パフォーマンスを即座に確認 **したい**
- **そうすることで** 日次の運用改善を迅速に実施できる

### ストーリー3: 月次レポート作成

- **である** マーケティングマネージャー **として**
- **私は** 先月の広告パフォーマンスデータを取得 **したい**
- **そうすることで** 月次レポートの作成と予算配分の最適化ができる

## 機能要件（EARS記法）

### 通常要件

- **REQ-001**: システムは、ユーザーが選択した日付範囲に基づいてMeta APIからデータを取得しなければならない
- **REQ-002**: システムは、取得したデータを集約し、広告クリエイティブごとの統計情報を表示しなければならない
- **REQ-003**: システムは、日付範囲の変更時に3秒以内にデータ取得を開始しなければならない
- **REQ-004**: システムは、以下の日付範囲オプションを提供しなければならない：
  - 昨日 (yesterday)
  - 過去7日 (last_7d)
  - 過去14日 (last_14d)
  - 過去30日 (last_30d)
  - 先月 (last_month)
  - 過去90日 (last_90d)
- **REQ-005**: システムは、日別データ（time_increment=1）を使用して時系列データを取得しなければならない

### 条件付き要件

- **REQ-101**: **WHEN** ユーザーが「昨日」を選択した場合、**THEN** システムは前日の0:00から23:59までのデータのみを取得しなければならない
- **REQ-102**: **WHEN** ユーザーが「先月」を選択した場合、**THEN** システムは前月の1日から末日までの全データを取得しなければならない
- **REQ-103**: **IF** APIレスポンスに複数日のデータが含まれる場合、**THEN** システムは同一クリエイティブ名でデータを集約しなければならない
- **REQ-104**: **WHEN** データ取得中の場合、**THEN** システムはローディングインジケータを表示しなければならない
- **REQ-105**: **IF** APIエラーが発生した場合、**THEN** システムは適切なエラーメッセージを表示し、リトライオプションを提供しなければならない

### 状態要件

- **REQ-201**: **WHERE** キャッシュデータが存在する場合、システムは日付範囲ごとに分離されたキャッシュを管理しなければならない
- **REQ-202**: **WHERE** ユーザーが未認証の状態の場合、システムは日付範囲フィルターを無効化しなければならない
- **REQ-203**: **WHERE** データ取得が進行中の場合、システムは新たな日付範囲変更リクエストをキューイングしなければならない

### オプション要件

- **REQ-301**: システムは、カスタム日付範囲の選択機能を提供してもよい
- **REQ-302**: システムは、よく使用される日付範囲をお気に入りとして保存する機能を提供してもよい
- **REQ-303**: システムは、複数の日付範囲を同時に比較表示する機能を提供してもよい

### 制約要件

- **REQ-401**: システムは、Meta Graph API v23.0を使用しなければならない
- **REQ-402**: システムは、time_incrementとbreakdownsパラメータを同時に使用してはならない
- **REQ-403**: システムは、30日以内のデータを5秒以内に表示完了しなければならない
- **REQ-404**: システムは、一度に取得するデータを最大500件に制限しなければならない

## 非機能要件

### パフォーマンス

- **NFR-001**: 日付範囲の変更から3秒以内にAPI呼び出しを開始する
- **NFR-002**: 30日間のデータを5秒以内に表示完了する
- **NFR-003**: 90日間のデータを10秒以内に表示完了する
- **NFR-004**: キャッシュヒット時は1秒以内にデータを表示する

### 信頼性

- **NFR-101**: API通信エラー時は最大3回まで自動リトライする
- **NFR-102**: レート制限エラー時は適切な待機時間後にリトライする
- **NFR-103**: 部分的なデータ取得成功時も、取得済みデータを表示する

### ユーザビリティ

- **NFR-201**: 日付範囲の選択はドロップダウンメニューで直感的に操作できる
- **NFR-202**: 現在選択中の日付範囲を明確に表示する
- **NFR-203**: データ更新中は進捗状況を表示する
- **NFR-204**: エラーメッセージは具体的で実行可能な対処法を含む

### データ整合性

- **NFR-301**: 同一期間を複数回選択した場合、常に同じデータが表示される
- **NFR-302**: 集約データの数値計算は小数点第2位まで正確である
- **NFR-303**: タイムゾーンはアカウント設定に従って一貫性を保つ

## Edgeケース

### エラー処理

- **EDGE-001**: 無効な日付範囲が指定された場合、デフォルト値（last_30d）にフォールバックする
- **EDGE-002**: APIトークンが無効な場合、再認証フローを開始する
- **EDGE-003**: ネットワークエラー時は、オフラインメッセージを表示し、自動リトライを行う
- **EDGE-004**: データが0件の場合、「該当期間のデータがありません」メッセージを表示する

### 境界値

- **EDGE-101**: 1日のみのデータ選択（最小期間）を正しく処理する
- **EDGE-102**: 90日間のデータ選択（最大期間）を正しく処理する
- **EDGE-103**: 月末日の処理（28日、29日、30日、31日）を正しく扱う
- **EDGE-104**: 年をまたぐ期間選択を正しく処理する

### 特殊ケース

- **EDGE-201**: 夏時間の切り替え時の日付計算を正しく処理する
- **EDGE-202**: うるう年の2月29日を含む期間を正しく処理する
- **EDGE-203**: 未来の日付が選択された場合、現在日までのデータを取得する

## 受け入れ基準

### 機能テスト

- [ ] 各日付範囲オプション（昨日、過去7日、14日、30日、先月、90日）が正しく動作する
- [ ] 日付範囲を変更するとAPIが再呼び出しされる
- [ ] APIリクエストに正しい日付パラメータ（date_preset、time_range）が含まれる
- [ ] レスポンスデータが選択した期間と一致する
- [ ] 同一クリエイティブ名のデータが正しく集約される
- [ ] ローディング表示が適切に表示・非表示される
- [ ] エラーメッセージが適切に表示される

### 非機能テスト

- [ ] 日付範囲変更から3秒以内にデータ取得が開始される
- [ ] 30日間のデータが5秒以内に表示される
- [ ] キャッシュが日付範囲ごとに分離管理される
- [ ] APIエラー時に最大3回リトライされる
- [ ] レート制限エラー時に適切な待機処理が行われる

### 統合テスト

- [ ] 「昨日」選択時に1日分のデータのみが取得される
- [ ] 「先月」選択時に前月の全日データが取得される
- [ ] 「過去30日」から「過去7日」への切り替え時にデータ件数が適切に変化する
- [ ] CSVエクスポートデータ（8月分）と「先月」選択時のデータが一致する
- [ ] 複数回の日付範囲変更が正しく処理される

### ユーザビリティテスト

- [ ] 日付範囲の選択が直感的に操作できる
- [ ] 現在選択中の日付範囲が明確に表示される
- [ ] エラーメッセージが理解しやすく、対処法が明確である
- [ ] データ更新中の進捗が確認できる

## データフロー詳細

```
1. [UI: DateRangeFilter Component]
   - ユーザーが日付範囲を選択
   - onDateRangeChange イベントを発火
   
2. [State: FatigueDashboardContainer]
   - dateRange stateを更新
   - 子コンポーネントに伝播
   
3. [Hook: useAdFatigueSimplified]
   - dateRangeパラメータを受け取る
   - datePresetとして変換
   
4. [Hook: useMetaInsights]
   - datePresetを受け取る
   - fetch関数でAPIパラメータを構築
   
5. [API: SimpleMetaApi.getTimeSeriesInsights]
   - date_preset または time_range パラメータを設定
   - time_increment=1 を設定
   - Meta Graph API v23.0 を呼び出し
   
6. [Response Processing]
   - 日別データを受信
   - aggregateTimeSeriesData で集約処理
   
7. [Cache: LocalCache]
   - 日付範囲をキーとしてキャッシュ保存
   
8. [UI: Table Display]
   - 集約されたデータを表示
   - 疲労度スコアを計算・表示
```

## 実装優先度

1. **P0（必須）**
   - REQ-001, REQ-002, REQ-003, REQ-004, REQ-005
   - REQ-101, REQ-102, REQ-103
   - REQ-401, REQ-402, REQ-403

2. **P1（重要）**
   - REQ-104, REQ-105
   - REQ-201, REQ-203
   - NFR-001, NFR-002, NFR-101

3. **P2（推奨）**
   - REQ-202
   - REQ-301, REQ-302
   - NFR-201, NFR-202, NFR-203

## 技術的考慮事項

1. **状態管理の簡素化**
   - 日付範囲の状態を単一のソースで管理
   - 不要な再レンダリングを防ぐためのメモ化

2. **キャッシュ戦略**
   - 日付範囲ごとのキーでキャッシュを分離
   - キャッシュの有効期限管理（1時間）

3. **エラーハンドリング**
   - グレースフルデグラデーション
   - 部分的成功の適切な処理

4. **テスタビリティ**
   - APIレスポンスのモック化
   - 日付計算ロジックの単体テスト
   - E2Eテストの自動化

---

*作成日: 2024年12月*
*バージョン: 1.0*
*ステータス: レビュー待ち*