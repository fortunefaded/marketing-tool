# Ad Fatigue 多軸表示機能 要件定義書

## 概要

現在の `/ad-fatigue` ページでは広告クリエイティブ単位での疲労度表示が行われているが、マーケティング担当者がより包括的な分析を行えるよう、「キャンペーン」「広告セット」軸でもパフォーマンスを確認できる機能を追加する。タブインターフェースにより、ユーザーは表示軸を切り替えて異なる視点から広告疲労度を分析できるようになる。

## ユーザストーリー

### ストーリー1: 多階層での広告疲労度分析

- **である** マーケティング担当者・広告運用者 **として**
- **私は** 広告疲労度データを広告クリエイティブ、広告セット、キャンペーンの各階層で表示・分析 **をしたい**
- **そうすることで** 問題の根本原因を特定し、戦略的な最適化の意思決定ができる

### ストーリー2: 階層的なドリルダウン分析

- **である** 広告運用マネージャー **として**
- **私は** キャンペーン全体から個別クリエイティブまで階層的にドリルダウン **をしたい**
- **そうすることで** 問題のあるキャンペーンや広告セットを素早く特定し、詳細分析ができる

## 機能要件（EARS記法）

### 通常要件

- REQ-001: システムは広告疲労度データを「広告クリエイティブ」「広告セット」「キャンペーン」の3つの表示軸で切り替え表示しなければならない
- REQ-002: システムは表示軸切り替えをタブインターフェースで提供しなければならない
- REQ-003: システムは各表示軸で疲労度スコア（0-100）、ステータス、Frequency、CTR、CPMを表示しなければならない
- REQ-004: システムは広告セット軸・キャンペーン軸において、配下の広告データを適切に集約して表示しなければならない
- REQ-005: システムは現行のアコーディオン形式での詳細表示を全ての表示軸で維持しなければならない

### 条件付き要件

- REQ-101: 広告セット軸が選択された場合、システムは各広告セットに属する広告クリエイティブ数を表示しなければならない
- REQ-102: キャンペーン軸が選択された場合、システムは各キャンペーンに属する広告セット数・クリエイティブ数を表示しなければならない
- REQ-103: データが存在しない表示軸が選択された場合、システムは適切な空状態メッセージを表示しなければならない
- REQ-104: 集約データに異常値が含まれる場合、システムは警告アイコンと説明を表示しなければならない

### 状態要件

- REQ-201: 表示軸切り替え中の場合、システムはローディングインジケーターを表示しなければならない
- REQ-202: 現在選択中の表示軸のタブは、視覚的に強調表示されなければならない
- REQ-203: データ同期中の場合、システムは全ての表示軸で同期状態を表示しなければならない

### オプション要件

- REQ-301: システムは各表示軸でソート機能（疲労度スコア、支出額、インプレッション等）を提供してもよい
- REQ-302: システムは表示軸ごとにフィルタリング機能（ステータス別、期間別）を提供してもよい
- REQ-303: システムはユーザーの最後に選択した表示軸をローカルストレージに保存してもよい
- REQ-304: システムは階層間のドリルダウン機能（キャンペーン→広告セット→クリエイティブ）を提供してもよい

### 制約要件

- REQ-401: システムは表示軸切り替え時に現在のアカウント選択状態を変更してはならない
- REQ-402: システムは集約データ表示時に、個別クリエイティブの重要な異常値を隠蔽してはならない
- REQ-403: システムは同時に複数の表示軸を選択状態にしてはならない
- REQ-404: システムは既存のFatigueData型の構造を破壊的に変更してはならない

## 非機能要件

### パフォーマンス

- NFR-001: 表示軸切り替えは2秒以内に完了しなければならない
- NFR-002: 1,000件の広告クリエイティブデータの集約処理は5秒以内に完了しなければならない
- NFR-003: メモリ使用量は現行実装の150%以内に抑えなければならない

### ユーザビリティ

- NFR-101: タブ切り替えは1クリックで実行できなければならない
- NFR-102: 階層関係は初回利用者でも5分以内に理解できる明瞭さでなければならない
- NFR-103: エラーメッセージは回復方法を明確に示さなければならない

### 互換性

- NFR-201: 現行の広告クリエイティブ軸表示機能と100%の後方互換性を維持しなければならない
- NFR-202: 既存のMeta APIとの統合を維持しなければならない

## データ集計ロジック

### 集計対象メトリクス

キャンペーン・広告セット単位で以下のメトリクスを集計・表示：

1. **広告費用（Spend）**: 配下要素の合計
2. **インプレッション（表示回数）**: 配下要素の合計
3. **クリック数**: 配下要素の合計
4. **コンバージョン（CV）**: 配下要素の合計
5. **CPA（獲得単価）**: 総広告費用 ÷ 総コンバージョン数
6. **CTR（クリック率）**: 総クリック数 ÷ 総インプレッション × 100
7. **CPC（クリック単価）**: 総広告費用 ÷ 総クリック数
8. **CVR（コンバージョン率）**: 総コンバージョン数 ÷ 総クリック数 × 100
9. **CPM（1000インプレッション単価）**: 総広告費用 ÷ 総インプレッション × 1000

### 広告セット軸の集計

```
- 広告費用: 配下全クリエイティブのspendの合計
- インプレッション: 配下全クリエイティブのimpressionsの合計
- クリック数: 配下全クリエイティブのclicksの合計
- コンバージョン: 配下全クリエイティブのconversionsの合計
- CPA: 総広告費用 ÷ 総コンバージョン（ゼロ除算回避）
- CTR: 総クリック数 ÷ 総インプレッション × 100
- CPC: 総広告費用 ÷ 総クリック数（ゼロ除算回避）
- CVR: 総コンバージョン ÷ 総クリック数 × 100
- CPM: 総広告費用 ÷ 総インプレッション × 1000
- Frequency: 総インプレッション ÷ 総リーチ
- 疲労度スコア: 集計されたメトリクスから再計算
```

### キャンペーン軸の集計

```
- 同様のロジックを全配下広告セット・クリエイティブに適用
- ステータスは最も悪い配下要素のステータスを採用（critical > warning > caution > healthy）
- 階層構造: キャンペーン → 広告セット → クリエイティブの全データを集約
```

### 集計時の注意事項

1. **ゼロ除算の回避**: CPA、CPC、CVR計算時は分母が0の場合0を返す
2. **通貨単位**: 全て日本円（¥）で統一、金額は整数表示（小数点以下切り上げ）
3. **パーセント表記**: CTR、CVRは小数点第2位まで表示
4. **null値の処理**: null/undefinedは0として扱う

## Edgeケース

### エラー処理

- EDGE-001: Meta APIからキャンペーン・広告セット情報が取得できない場合、クリエイティブ軸のみを有効にし、エラーメッセージを表示する
- EDGE-002: 集計対象データが0件の場合、「データがありません」メッセージと再同期ボタンを表示する
- EDGE-003: メタデータ（キャンペーン名、広告セット名）が欠損している場合、IDベースの表示と警告アイコンを表示する

### 境界値

- EDGE-101: 1つのキャンペーンに1,000以上の広告が存在する場合、ページネーション（50件/ページ）を実装する
- EDGE-102: 疲労度スコア計算で異常値（負数、100超過）が発生した場合、0-100範囲にクランプし警告を表示する
- EDGE-103: Frequencyが0またはnullの場合、「データ不足」ステータスを表示する

### データ整合性

- EDGE-201: 削除された広告セット・キャンペーンのデータが残っている場合、「削除済み」ラベルを付けて表示する
- EDGE-202: 同一キャンペーン内で通貨が混在している場合、アカウントのデフォルト通貨に統一し混在警告を表示する

## 受け入れ基準

### 機能テスト

- [ ] 3つのタブ（クリエイティブ/広告セット/キャンペーン）が正しく表示される
- [ ] タブクリックで表示軸が適切に切り替わる
- [ ] 各軸で疲労度データ（スコア、ステータス、メトリクス）が正しく表示される
- [ ] アコーディオン展開で詳細メトリクスが表示される
- [ ] 現行のクリエイティブ軸表示が変更されていない
- [ ] 広告セット軸で配下クリエイティブが正しく集約される
- [ ] キャンペーン軸で配下階層が正しく集約される
- [ ] 集約された疲労度スコアが適切に計算される
- [ ] コンバージョン、CVR、CPAが正しく集計・表示される
- [ ] ¥記号が金額の前に正しく表示される（例：¥227,276）
- [ ] CPMが整数で表示される（小数点以下切り上げ）

### UXテスト

- [ ] 表示軸切り替え時にローディング状態が表示される
- [ ] 選択中のタブが視覚的に識別できる
- [ ] データが存在しない軸で適切なメッセージが表示される
- [ ] 各軸でデータ件数（配下要素数）が表示される

### エラーハンドリングテスト

- [ ] APIエラー時に適切なエラーメッセージが表示される
- [ ] データ不整合時に警告が表示される
- [ ] エラー状態から回復する手段（再同期等）が提供される

### パフォーマンステスト

- [ ] タブ切り替えが2秒以内で完了する
- [ ] 500件以上のデータでも許容可能な応答時間を維持する
- [ ] メモリリークが発生しない
- [ ] 表示軸切り替えを繰り返してもパフォーマンスが劣化しない

### 非機能テスト

- [ ] 同期ボタンが全ての表示軸で機能する
- [ ] アカウント切り替えが全ての表示軸で正常に動作する
- [ ] ブラウザのリロード後も機能が正常に動作する