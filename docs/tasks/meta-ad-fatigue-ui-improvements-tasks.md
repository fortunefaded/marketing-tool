# Meta広告疲労度分析ダッシュボード UI/UX改善 - 実装タスク

## プロジェクト概要

既存のMeta広告疲労度分析ダッシュボードにおいて、「集約：ON」トグルボタンを廃止し、常に集約表示をデフォルトにする。また、既存モーダル内のグラフを媒体別（Facebook/Instagram/Audience Network）の複数線表示に拡張し、Meta Ads Managerとの数値整合性を向上させる。

**要件定義書**: [`docs/spec/meta-ad-fatigue-ui-improvements-requirements.md`](../spec/meta-ad-fatigue-ui-improvements-requirements.md)  
**技術設計書**: [`docs/design/meta-ad-fatigue-ui-improvements/`](../design/meta-ad-fatigue-ui-improvements/)

## 実装フェーズ

### Phase 0: 事前準備 (1日)
### Phase 1: 集約機能簡素化 (1日・必須)  
### Phase 2: グラフ拡張 (3-4日・主要機能)
### Phase 3: 最適化 (オプション)

---

## Phase 0: 事前準備

### TASK-000: プロジェクト初期化と環境確認
- [x] **要件**: 実装環境の準備とベースライン確認
- [ ] **説明**: 既存テストスイート実行、AdDataAggregatorの拡張ポイント特定、現在の集約機能の動作検証
- [ ] **依存**: なし
- [ ] **推定時間**: 4時間
- [ ] **担当者**: 開発者
- [ ] **優先度**: 高
- [ ] **実装タイプ**: 直接作業プロセス

**詳細作業内容:**
- 既存テストスイートの実行と基準値記録 (`npm test`, `npm run typecheck`, `npm run lint`)
- AdDataAggregatorの現在の実装確認と拡張ポイント特定
- 疲労度ダッシュボードの現在の動作確認
- 設計文書との整合性確認
- 開発環境のセットアップ確認

---

## Phase 1: 集約機能簡素化 (必須)

### TASK-101: 集約トグルボタンの削除
- [x] **要件**: REQ-001 (常に集約されたデータを表示)
- [x] **説明**: FatigueDashboardコンポーネントから「集約：ON」トグルボタンを削除し、UIを簡素化する
- [x] **依存**: TASK-000
- [x] **推定時間**: 2時間 → **実際**: 15分
- [x] **担当者**: フロントエンド開発者
- [x] **優先度**: 高
- [x] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- `src/features/meta-api/components/FatigueDashboard.tsx`からトグルボタンUI削除
- 関連するスタイルとイベントハンドラーの削除
- UIテストの更新
- 集約表示の動作確認

### TASK-102: 常時集約モードの実装
- [x] **要件**: REQ-001 (システムは常に集約されたデータを表示)
- [x] **説明**: enableAggregationフラグをデフォルトtrueに固定し、集約機能を常時有効化
- [x] **依存**: TASK-101
- [x] **推定時間**: 3時間 → **実際**: 20分 (TASK-101で部分完了済み)
- [x] **担当者**: バックエンド開発者
- [x] **優先度**: 高
- [x] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- AdDataAggregatorのデフォルト設定変更
- `SimplifiedAggregationConfig`インターフェースの実装
- 集約処理の常時有効化
- 関連テストの更新
- データ表示の整合性確認

### TASK-103: Phase 1統合テストと検証
- [x] **要件**: Phase 1の受け入れ基準達成確認
- [x] **説明**: 集約機能簡素化の動作確認と既存機能への影響評価
- [x] **依存**: TASK-101, TASK-102
- [x] **推定時間**: 2時間
- [x] **担当者**: QA担当者
- [x] **優先度**: 高  
- [x] **実装タイプ**: 直接作業プロセス

**詳細作業内容:**
- [x] 「集約：ON」トグルボタンが画面から削除されている確認
- [x] データが常に集約された状態で表示される確認
- [x] 既存の分析機能が正常に動作する確認
- [x] Meta Ads Managerとの数値一致確認

**完了日**: 2025-08-28  
**テスト結果**: 15/15テスト成功 (SimplifiedAggregationConfig: 9/9, Toggle削除: 6/6)

---

## Phase 2: グラフ拡張 (主要機能)

### TASK-201: 拡張データ構造の実装
- [x] **要件**: REQ-003 (媒体別指標表示), REQ-006, REQ-007 (データ整合性)
- [x] **説明**: 媒体別データを扱うためのTypeScript型定義とデータ構造を実装
- [x] **依存**: TASK-103
- [x] **推定時間**: 4時間
- [x] **担当者**: バックエンド開発者
- [x] **優先度**: 高
- [x] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- [x] `EnhancedAdPerformanceData`インターフェースの実装
- [x] `PlatformSpecificMetrics`型定義の実装  
- [x] `DataConsistencyResult`型定義の実装
- [x] 型安全性テストの実装
- [x] 既存型との互換性確認

**完了日**: 2025-08-28  
**TDD結果**: 9/9テスト成功 (RED→GREEN→REFACTOR完了)  
**実装成果**: 
- `PlatformSpecificMetrics`, `GraphDataPoint`, `EnhancedAdPerformanceData`型定義
- `DataConsistencyResult`, `EnhancedAggregationOptions`拡張型
- 既存`AdPerformanceData`との完全互換性確保

### TASK-202: AdDataAggregator拡張
- [x] **要件**: REQ-003, REQ-006, REQ-007 (媒体別集約とデータ整合性)
- [x] **説明**: AdDataAggregatorクラスを拡張し、媒体別データの集約と整合性チェック機能を追加
- [x] **依存**: TASK-201
- [x] **推定時間**: 6時間
- [x] **担当者**: バックエンド開発者
- [x] **優先度**: 高
- [x] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- [x] プラットフォーム別データ集約機能の実装
- [x] データ整合性チェックロジックの実装
- [x] 丸め誤差調整機能の実装 (REQ-007)
- [x] 媒体別時系列データ生成機能
- [x] 包括的なユニットテストの実装

**完了日**: 2025-08-28  
**TDD結果**: 8/8テスト成功 (RED→GREEN→REFACTOR完了)  
**実装成果**:
- `EnhancedAdDataAggregator`クラス: 拡張集約エンジン
- プラットフォーム別グラフデータ生成 (Facebook/Instagram/Audience Network)
- データ整合性チェック機能 (許容誤差2%, 3段階severity)
- 8指標対応: CTR, CPM, CPC, CPA, ROAS, conversions, impressions, spend
- エラーハンドリング強化、パフォーマンス監視機能

### TASK-203: 媒体別チャートデータ変換器の実装
- [x] **要件**: REQ-002, REQ-003 (媒体別グラフ表示)
- [x] **説明**: 集約データをマルチラインチャート形式に変換する機能を実装
- [x] **依存**: TASK-202
- [x] **推定時間**: 4時間
- [x] **担当者**: フロントエンド開発者
- [x] **優先度**: 高
- [x] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- [x] `ChartDataTransformer`クラスの実装
- [x] 媒体別時系列データフォーマット機能
- [x] チャート表示用データ構造への変換
- [x] エラーハンドリングとフォールバック機能
- [x] データ変換テストの実装

**完了日**: 2025-08-28  
**TDD結果**: 10/10テスト成功 (RED→GREEN→REFACTOR完了)  
**実装成果**:
- `ChartDataTransformer`クラス: Recharts形式変換エンジン  
- プラットフォーム別色分け設定 (Facebook Blue, Instagram Pink等)
- 複数指標対応: CTR, CPM, CPC, CPA, ROAS, conversions, impressions, spend
- パフォーマンス最適化: 1000件以上で自動最適化モード
- エラーハンドリング: 不完全データ・無効日付対応
- 10項目包括テスト: 基本変換, 色設定, 複数指標, エラー処理, パフォーマンス

### TASK-204: マルチラインチャートコンポーネント実装
- [x] **要件**: REQ-002, REQ-003, REQ-005 (媒体別グラフと色分け)
- [x] **説明**: Rechartsを使用した媒体別複数線表示チャートコンポーネントを実装
- [x] **依存**: TASK-203
- [x] **推定時間**: 8時間
- [x] **担当者**: フロントエンド開発者
- [x] **優先度**: 高
- [x] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- [x] `MultiLineChart`コンポーネントの実装
- [x] 媒体別カラーマッピング (Facebook: 青, Instagram: 紫, Audience Network: 緑)
- [x] 線種の実装 (実線, 破線, 点線) - アクセシビリティ対応
- [x] レスポンシブデザイン対応
- [x] コンポーネントテストの実装

**完了日**: 2025-08-28  
**TDD結果**: 12/12テスト成功 (RED→GREEN→REFACTOR完了)  
**実装成果**:
- `MultiLineChart`コンポーネント: Recharts完全統合
- プラットフォーム別色分け: Facebook Blue (#1877F2), Instagram Pink (#E4405F), Audience Network Green (#42B883)
- アクセシビリティ対応: 線種自動切り替え (solid/dashed/dotted)
- レスポンシブ: ResponsiveContainer使用、カスタム寸法対応
- パフォーマンス最適化: useMemo/useCallback, 大量データ対応
- エラーハンドリング: 空データ・無効形式の適切な表示
- カスタムツールチップ: 単位・小数点・フォーマッタ対応

### TASK-205: インタラクティブ凡例コンポーネント実装
- [ ] **要件**: REQ-004, REQ-102, REQ-103 (凡例とトグル機能)
- [ ] **説明**: 媒体の表示/非表示を切り替えるインタラクティブ凡例を実装
- [ ] **依存**: TASK-204
- [ ] **推定時間**: 5時間
- [ ] **担当者**: フロントエンド開発者
- [ ] **優先度**: 高
- [ ] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- `InteractiveLegend`コンポーネントの実装
- 媒体トグルチェックボックス機能
- データ不足時のグレーアウト表示 (REQ-103)
- アクセシビリティ対応 (aria-label等)
- インタラクションテストの実装

### TASK-206: ツールチップ機能実装
- [ ] **要件**: REQ-101 (ホバー時の数値表示)
- [ ] **説明**: グラフ上の点にホバーした際の媒体別数値ツールチップを実装
- [ ] **依存**: TASK-205
- [ ] **推定時間**: 4時間
- [ ] **担当者**: フロントエンド開発者
- [ ] **優先度**: 中
- [ ] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- カスタムツールチップコンポーネントの実装
- 媒体別数値の詳細表示
- ホバーイベントハンドリング
- タッチデバイス対応 (タップ表示)
- ツールチップテストの実装

### TASK-207: 拡張CreativeDetailModal実装
- [ ] **要件**: REQ-002, REQ-202 (モーダル内グラフ表示)
- [ ] **説明**: 既存のCreativeDetailModalを拡張し、媒体別グラフを統合
- [ ] **依存**: TASK-206
- [ ] **推定時間**: 6時間
- [ ] **担当者**: フロントエンド開発者
- [ ] **優先度**: 高
- [ ] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- `EnhancedCreativeDetailModal`の実装
- 既存モーダル構造の維持 (REQ-401)
- マルチラインチャートの統合
- モーダル内でのインタラクション対応
- モーダル統合テストの実装

### TASK-208: Phase 2統合テストと検証
- [ ] **要件**: Phase 2の受け入れ基準達成確認
- [ ] **説明**: 媒体別グラフ機能の包括的テストと性能検証
- [ ] **依存**: TASK-207
- [ ] **推定時間**: 4時間
- [ ] **担当者**: QA担当者
- [ ] **優先度**: 高
- [ ] **実装タイプ**: 直接作業プロセス

**詳細作業内容:**
- 全メトリクスの媒体別表示確認 (広告費用, インプレッション, CTR, Frequency, クリック数, コンバージョン)
- 媒体別カラーコードの確認 (FB: 青, IG: 紫, AN: 緑)
- 凡例とトグル機能の動作確認
- ツールチップの正確性確認
- モバイル環境での表示確認
- パフォーマンステスト (グラフ描画1秒以内, トグル500ms以内, ツールチップ200ms以内)

---

## Phase 3: 最適化とエラーハンドリング (オプション)

### TASK-301: エラーハンドリング強化
- [ ] **要件**: EDGE-001, EDGE-002, EDGE-003 (エラー処理)
- [ ] **説明**: データ不足、API エラー、大量データ等のエッジケース対応を実装
- [ ] **依存**: TASK-208
- [ ] **推定時間**: 5時間
- [ ] **担当者**: バックエンド開発者
- [ ] **優先度**: 中
- [ ] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- データ不足時の警告表示実装
- APIエラー時のフォールバック機能
- 大量データのサンプリング機能 (1000ポイント以上)
- エラーログとパフォーマンスメトリクス実装
- エラーシナリオテストの実装

### TASK-302: パフォーマンス最適化
- [ ] **要件**: NFR-001, NFR-002, NFR-003 (パフォーマンス要件)
- [ ] **説明**: メモ化、仮想化、キャッシュ最適化によるパフォーマンス向上
- [ ] **依存**: TASK-301
- [ ] **推定時間**: 4時間
- [ ] **担当者**: フロントエンド開発者
- [ ] **優先度**: 中
- [ ] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- React.memo、useMemo、useCallbackの最適実装
- チャートデータのメモ化
- 大量データ時の仮想化実装
- レンダリングパフォーマンスの測定と改善
- パフォーマンステストの実装

### TASK-303: アクセシビリティ強化
- [ ] **要件**: NFR-202 (WCAG 2.1 AA準拠)
- [ ] **説明**: アクセシビリティガイドラインに準拠した機能強化
- [ ] **依存**: TASK-302
- [ ] **推定時間**: 3時間
- [ ] **担当者**: フロントエンド開発者
- [ ] **優先度**: 中
- [ ] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- ARIA属性の実装とスクリーンリーダー対応
- キーボードナビゲーションの実装
- カラーコントラスト比の検証 (4.5:1以上)
- フォーカスインジケーターの実装
- アクセシビリティテストの実装

### TASK-304: 追加機能実装 (オプション)
- [ ] **要件**: REQ-301, REQ-302, REQ-303 (オプション機能)
- [ ] **説明**: CSVエクスポート、ワンタイムメッセージ、合計値点線表示等の追加機能
- [ ] **依存**: TASK-303
- [ ] **推定時間**: 6時間
- [ ] **担当者**: フルスタック開発者
- [ ] **優先度**: 低
- [ ] **実装タイプ**: TDDプロセス

**詳細作業内容:**
- CSVエクスポート機能の実装
- 移行説明のワンタイムメッセージ実装
- 合計値の点線/太線表示オプション
- ユーザー設定の永続化
- 追加機能テストの実装

### TASK-305: 最終統合テストと本番準備
- [ ] **要件**: 全要件の受け入れ基準達成確認
- [ ] **説明**: 包括的なシステムテストと本番展開準備
- [ ] **依存**: TASK-304
- [ ] **推定時間**: 4時間
- [ ] **担当者**: QA担当者 + DevOps担当者
- [ ] **優先度**: 高
- [ ] **実装タイプ**: 直接作業プロセス

**詳細作業内容:**
- 全受け入れ基準の最終確認
- ブラウザ間互換性テスト
- パフォーマンス要件の最終検証
- セキュリティテスト
- 本番環境への展開準備

---

## 成功指標と検証項目

### 定量指標
- [ ] 集約機能問い合わせ数: 50%減少
- [ ] 媒体別分析時間: 30%短縮  
- [ ] Meta Ads Manager数値一致率: 100%達成
- [ ] グラフ描画時間: 1秒以内
- [ ] トグル操作応答: 500ms以内
- [ ] ツールチップ表示: 200ms以内

### 定性指標
- [ ] ユーザー操作の直感性向上
- [ ] データ信頼性の向上
- [ ] 分析効率の改善
- [ ] モバイル対応の適切性

## 技術スタック

- **フロントエンド**: React 18, TypeScript, Tailwind CSS, Recharts
- **バックエンド**: Convex Functions, Node.js
- **テスト**: Vitest, React Testing Library, Playwright
- **CI/CD**: 既存パイプライン使用

## リスク管理

### 高リスク
- AdDataAggregator変更による既存機能への影響
- 大量データ処理時のパフォーマンス劣化
- 媒体別データの整合性エラー

### 対策
- 段階的実装とリグレッションテスト
- パフォーマンス監視とメモ化実装
- 自動データ検証と調整機能

## 依存関係図

```
TASK-000 (準備)
    ↓
TASK-101 (トグル削除) → TASK-102 (常時集約) → TASK-103 (Phase1テスト)
    ↓
TASK-201 (データ構造) → TASK-202 (集約拡張) → TASK-203 (変換器)
    ↓                                          ↓
TASK-204 (チャート) → TASK-205 (凡例) → TASK-206 (ツールチップ)
    ↓                                          ↓
TASK-207 (モーダル) → TASK-208 (Phase2テスト)
    ↓
TASK-301 (エラー処理) → TASK-302 (パフォーマンス) → TASK-303 (アクセシビリティ)
    ↓                                              ↓
TASK-304 (追加機能) → TASK-305 (最終テスト)
```

## 実装完了基準

各タスクは以下の基準を満たした時点で完了とする:

1. **機能実装完了**: 要件で定義された機能が正常に動作
2. **テスト通過**: ユニットテスト・統合テストが全て通過
3. **コードレビュー完了**: チームメンバーによるレビューが完了
4. **ドキュメント更新**: 実装に伴う文書の更新が完了
5. **受け入れテスト通過**: 要件定義の受け入れ基準を満たす

---

**プロジェクト開始日**: 2025-08-28  
**予定完了日**: 2025-09-05 (8営業日)  
**総推定工数**: 69時間 (約8.6人日)**注意事項**

- Phase 1は必須実装、Phase 2は主要機能、Phase 3はオプション
- 各タスクの実装前に依存タスクの完了を確認
- パフォーマンス要件を満たさない場合は実装方法の見直しを実施
- 既存機能への影響が発見された場合は即座に対応を検討