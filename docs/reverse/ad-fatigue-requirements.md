# Ad Fatigue 要件定義書（逆生成）

## 分析概要

**分析日時**: 2024-08-25
**対象コードベース**: `/src/features/meta-api/`
**抽出要件数**: 25個の機能要件、12個の非機能要件
**信頼度**: 85% （実装カバレッジに基づく）

## システム概要

### 推定されたシステム目的
広告疲労度分析システムは、Meta広告の効果測定を自動化し、マーケティング担当者でなくとも広告パフォーマンスの劣化を早期発見できるようにすることを目的としている。3つの疲労度指標（クリエイティブ疲労、視聴者疲労、アルゴリズム疲労）を用いて総合的にスコアリングし、広告運用の最適化を支援する。

### 対象ユーザー
- マーケティング担当者
- 広告運用者
- 広告代理店のアカウントマネージャー
- デジタルマーケティング初心者

## ユーザーストーリー

### ストーリー1: 広告疲労度の可視化
- **である** マーケティング担当者 **として**
- **私は** 広告クリエイティブの疲労度を一目で確認 **をしたい**
- **そうすることで** パフォーマンスが低下した広告を早期に発見し、迅速な対応ができる

**実装根拠**: 
- `FatigueDashboard.tsx` - メインダッシュボード実装
- `SimpleFatigueCalculator.ts` - 疲労度スコア計算ロジック
- `StatCard` コンポーネント - Critical/Warning/Healthyの視覚的分類

### ストーリー2: 詳細メトリクスの分析
- **である** 広告運用者 **として**
- **私は** 各広告の詳細なパフォーマンスメトリクスを確認 **をしたい**
- **そうすることで** 疲労の原因を特定し、適切な改善策を立案できる

**実装根拠**:
- `FatigueAccordion.tsx` - アコーディオン形式の詳細表示
- `MetricRow` コンポーネント - 各メトリクスの閾値判定と表示
- Instagram特有メトリクスの実装

### ストーリー3: マルチアカウント管理
- **である** 広告代理店担当者 **として**
- **私は** 複数のMetaアカウントを切り替えて管理 **をしたい**
- **そうすることで** 複数クライアントの広告を効率的に運用できる

**実装根拠**:
- `AccountSelector` コンポーネント
- `SimpleAccountStore` - アカウント管理
- アクティブアカウントの永続化

### ストーリー4: データの最新性確保（推定）
- **である** リアルタイムマーケター **として**
- **私は** 最新の広告データで分析 **をしたい**
- **そうすることで** タイムリーな意思決定ができる

**実装根拠**:
- 「データ更新」ボタンの実装
- キャッシュとAPIのハイブリッド戦略
- データソース表示（キャッシュ/Meta API）

## 機能要件（EARS記法）

### 通常要件

#### REQ-001: 広告疲労度スコアの計算
システムは各広告クリエイティブに対して0-100の疲労度スコアを計算しなければならない。

**実装根拠**: 
- `SimpleFatigueCalculator.calculateScore()` メソッド
- Frequency、CTR、CPMの3要素による計算式
- スコア = (frequencyScore + ctrPenalty + cpmPenalty) / 3

#### REQ-002: 疲労度ステータスの分類
システムは疲労度スコアに基づいて広告を4段階（healthy/caution/warning/critical）に分類しなければならない。

**実装根拠**:
- `getStatus()` メソッド：70以上=critical、50以上=warning、30以上=caution、30未満=healthy
- カラーコーディング（緑/黄/オレンジ/赤）

#### REQ-003: Meta API統合
システムはMeta Graph APIから広告インサイトデータを取得しなければならない。

**実装根拠**:
- `SimpleMetaApi` クラス
- `/v18.0/act_{ad_account_id}/insights` エンドポイント使用
- level='ad'での詳細データ取得

#### REQ-004: 基本メトリクスの表示
システムは以下の基本メトリクスを表示しなければならない：
- 広告費用（Spend）
- インプレッション（表示回数）
- クリック数
- CTR（クリック率）
- CPC（クリック単価）
- CPM（1000インプレッション単価）
- Frequency（広告表示頻度）
- コンバージョン（CV）
- CPA（獲得単価）
- CVR（コンバージョン率）

**実装根拠**:
- `FatigueAccordion` での各メトリクス表示
- `MetricRow` コンポーネントでの統一的な表示
- 日本円（¥）での金額表示

#### REQ-005: 表示モードの切り替え
システムはテーブル表示と詳細表示（アコーディオン）の2つの表示モードを提供しなければならない。

**実装根拠**:
- `viewMode` state管理
- `FatigueTable` と `FatigueAccordion` コンポーネント
- トグルボタンUI

### 条件付き要件

#### REQ-101: Frequency閾値判定
Frequencyが3.5を超える場合、システムは「危険水準」として警告を表示しなければならない。

**実装根拠**:
- `getFrequencyStatus()` 関数
- 3.5超=danger、2.8超=warning、それ以下=safe
- CLAUDE.mdでの基準値定義

#### REQ-102: CTR低下判定
CTRがベースラインから25%以上低下した場合、システムは「危険水準」として警告を表示しなければならない。

**実装根拠**:
- `getCtrStatus()` 関数
- ベースライン2.0%からの低下率計算
- 25%以上低下=danger、15%以上=warning

#### REQ-103: CPM上昇判定
CPMがベースラインから20%以上上昇した場合、システムは「危険水準」として警告を表示しなければならない。

**実装根拠**:
- `getCpmStatus()` 関数
- ベースライン30からの上昇率計算
- 20%以上上昇=danger、10%以上=warning

#### REQ-104: アカウント未選択時の処理
アカウントが選択されていない場合、システムは適切なメッセージを表示しなければならない。

**実装根拠**:
- 「Please select an account to view fatigue data」表示
- 条件付きレンダリング実装

#### REQ-105: データ取得エラー時の処理
API エラーが発生した場合、システムはエラーメッセージと回復手段を提供しなければならない。

**実装根拠**:
- `Alert` コンポーネントでのエラー表示
- Meta API設定画面へのリンク提供
- 再試行ボタン

### 状態要件

#### REQ-201: ローディング状態
データ取得中の場合、システムはローディングインジケーターを表示しなければならない。

**実装根拠**:
- `isLoading` state管理
- スピナーアニメーション表示
- 「Loading fatigue data...」メッセージ

#### REQ-202: データソース表示
システムは現在のデータソース（キャッシュ/Meta API）を表示しなければならない。

**実装根拠**:
- `dataSource` state管理
- UI上での「データソース: キャッシュ/Meta API」表示

#### REQ-203: アコーディオン展開状態
システムは各広告の詳細表示の展開/折りたたみ状態を管理しなければならない。

**実装根拠**:
- `expandedItems` Set による状態管理
- ChevronIcon による視覚的フィードバック

### オプション要件

#### REQ-301: Instagram特有メトリクス表示
システムはInstagram特有のメトリクス（エンゲージメント率、プロフィール訪問数等）を表示してもよい。

**実装根拠**:
- `instagram_metrics` フィールド
- エンゲージメント率計算ロジック
- 業界平均との比較（0.7%、Reels 1.23%）

#### REQ-302: データ検証アラート
システムはデータの妥当性を検証し、異常値について警告を表示してもよい。

**実装根拠**:
- `DataValidationAlert` コンポーネント
- 数値フィールドの妥当性チェック
- ゼロ値の多い指標の警告

#### REQ-303: キャッシュ利用
システムは取得したデータをキャッシュして再利用してもよい。

**実装根拠**:
- `useConvexCache` フック
- キャッシュ優先のデータ取得戦略
- キャッシュエラー時のフォールバック

### 制約要件

#### REQ-401: 疲労度スコアの範囲
システムは疲労度スコアを0-100の範囲内で計算しなければならない。

**実装根拠**:
- `Math.min(100, frequency * 20)` による上限設定
- `Math.round()` による整数化

#### REQ-402: 金額表示形式
システムは金額を日本円（¥）で、整数表示（CPMは切り上げ）しなければならない。

**実装根拠**:
- `Math.ceil()` によるCPM切り上げ
- ¥記号の前置表示
- `toLocaleString('ja-JP')` による数値フォーマット

#### REQ-403: Meta APIアクセストークン必須
システムはMeta APIアクセスにアクセストークンを必要としなければならない。

**実装根拠**:
- `SimpleTokenStore` によるトークン管理
- トークンエラー時のエラーハンドリング

## 非機能要件

### パフォーマンス

#### NFR-001: データ取得応答時間
システムは通常のデータ取得を30秒以内に完了しなければならない。

**実装根拠**:
- `timeout: 30000` のデフォルト設定
- タイムアウト時のAbortController使用

#### NFR-002: ページネーション対応
システムは100件以上の広告データを処理できなければならない。

**実装根拠**:
- Meta APIのページネーション実装
- `fetchPaginatedData()` メソッド

#### NFR-003: メモリ効率
システムは大量データ処理時のメモリ使用を最適化しなければならない。

**推定根拠**:
- データ変換時の効率的な処理
- 不要なデータの早期解放

### セキュリティ

#### NFR-101: アクセストークン保護
システムはアクセストークンを安全に管理しなければならない。

**実装根拠**:
- Convexでの暗号化保存
- ログでのトークン隠蔽（TOKEN_HIDDEN）

#### NFR-102: クロスサイトスクリプティング対策
システムはXSS攻撃を防ぐ対策を実装しなければならない。

**実装根拠**:
- Reactのデフォルトエスケープ機能
- 動的HTMLの非使用

### ユーザビリティ

#### NFR-201: 視覚的フィードバック
システムは疲労度を色で直感的に理解できるようにしなければならない。

**実装根拠**:
- 4色のカラーコーディング（緑/黄/オレンジ/赤）
- ステータスアイコンの使用

#### NFR-202: レスポンシブデザイン
システムは異なる画面サイズで適切に表示されなければならない。

**実装根拠**:
- Tailwind CSSのレスポンシブクラス使用
- グリッドレイアウトの採用

#### NFR-203: エラーメッセージの明確性
システムは理解しやすいエラーメッセージを表示しなければならない。

**実装根拠**:
- 日本語エラーメッセージ
- 回復手段の提示（「Meta API設定を開く」リンク）

### 運用性

#### NFR-301: ログ出力
システムは重要な操作をログに記録しなければならない。

**実装根拠**:
- `vibe` ロガーの使用
- ストーリー形式のログ記録
- デバッグ情報の出力

#### NFR-302: エラー追跡
システムは発生したエラーを追跡可能でなければならない。

**実装根拠**:
- エラー分類（auth/data/network/timeout）
- エラーコンテキストの記録

## Edgeケース

### エラー処理

#### EDGE-001: アクセストークン期限切れ
アクセストークンが期限切れの場合の処理

**実装根拠**:
- 401エラーの検出
- 「トークンが期限切れです」メッセージ
- 再認証へのナビゲーション

#### EDGE-002: Meta API レート制限
API呼び出し制限に達した場合の処理

**実装根拠**:
- 429エラーの検出
- レート制限エラーメッセージ
- リトライ可能フラグ

#### EDGE-003: ネットワーク接続エラー
ネットワーク障害時の処理

**実装根拠**:
- キャッシュへのフォールバック
- オフライン時のエラーメッセージ

### 境界値

#### EDGE-101: ゼロ値処理
メトリクスが0またはnullの場合の処理

**実装根拠**:
- デフォルト値0の設定
- ゼロ除算の回避（CVR、CPA計算）
- 「データ不足」ステータス

#### EDGE-102: 異常値処理
異常に大きい/小さい値の処理

**実装根拠**:
- 数値検証ロジック
- 警告表示（DataValidationAlert）

#### EDGE-103: 空データ処理
広告データが0件の場合の処理

**実装根拠**:
- 「広告データが見つかりません」メッセージ
- 再取得ボタンの提供

### データ整合性

#### EDGE-201: 広告名の欠損
広告名が設定されていない場合の処理

**実装根拠**:
- 'Unnamed' または 'Unnamed Ad' のフォールバック
- IDベースの識別

#### EDGE-202: キャンペーン情報の欠損
キャンペーン名やIDが欠損している場合の処理

**実装根拠**:
- 'Unnamed Campaign' のフォールバック
- オプショナルフィールドとしての処理

## 受け入れ基準

### 実装済み機能テスト

- [x] 疲労度スコア計算機能
  - [x] 3つの指標による総合スコア計算
  - [x] 0-100範囲でのスコア正規化
  - [x] 4段階ステータス分類
- [x] データ取得機能
  - [x] Meta APIからのデータ取得
  - [x] キャッシュ機能
  - [x] エラーハンドリング
- [x] UI表示機能
  - [x] ダッシュボード表示
  - [x] テーブル/アコーディオン切り替え
  - [x] 詳細メトリクス表示
  - [x] 色による視覚的フィードバック
- [x] アカウント管理機能
  - [x] 複数アカウントの切り替え
  - [x] アクティブアカウントの永続化

### 推奨追加テスト

- [ ] **パフォーマンステスト**
  - [ ] 1000件以上のデータでの応答時間測定
  - [ ] メモリ使用量の監視
  - [ ] 同時リクエストの負荷テスト
- [ ] **統合テスト**
  - [ ] Meta APIとの実際の連携テスト
  - [ ] キャッシュ有効期限のテスト
  - [ ] エラーリカバリーのシナリオテスト
- [ ] **アクセシビリティテスト**
  - [ ] スクリーンリーダー対応テスト
  - [ ] キーボードナビゲーションテスト
  - [ ] 色覚異常対応テスト

## 推定されていない要件

### 不明確な部分

以下の要件は実装から推定が困難なため、ステークホルダーとの確認が必要：

1. **ビジネス要件**
   - CTR/CPMのベースライン値の決定方法
   - 業界/商材別の閾値カスタマイズ
   - 疲労度スコアの重み付け調整

2. **データ要件**
   - データ保持期間
   - 過去データとの比較分析
   - 他媒体（Google広告等）との統合

3. **運用要件**
   - アラート通知機能
   - レポート自動生成
   - 定期的なデータ同期スケジュール

### 将来的な拡張要件（ユーザー要望）

#### REQ-501: 多軸表示機能
システムは広告クリエイティブ単位だけでなく、キャンペーン・広告セット単位でも疲労度を表示できなければならない。

**要望根拠**:
- より高次元での分析ニーズ
- 階層的な問題特定
- 戦略レベルでの意思決定支援

#### REQ-502: 集計ロジック
キャンペーン・広告セット単位では、配下要素の以下メトリクスを集計しなければならない：
- 広告費用（合計）
- インプレッション（合計）
- クリック数（合計）
- コンバージョン（合計）
- CPA（総広告費用÷総CV）
- CTR（総クリック÷総インプレッション）
- CPC（総広告費用÷総クリック）
- CVR（総CV÷総クリック）
- CPM（総広告費用÷総インプレッション×1000）

**実装方針**:
- タブインターフェースでの切り替え
- 階層的なデータ集約サービス
- 既存コンポーネントの再利用

### 推奨される次ステップ

1. **要件確認会議** - ベースライン値と閾値の確定
2. **ユーザビリティテスト** - 実際の広告運用者による使用感確認
3. **パフォーマンス最適化** - 大量データ処理の改善
4. **多軸表示機能の実装** - キャンペーン/広告セット軸の追加

## 分析の制約事項

### 信頼度に影響する要因

- **テストコード不足**: ユニットテストが限定的
- **コメント不足**: ビジネスロジックの意図が不明確な箇所あり
- **ドキュメント不足**: API仕様書やユーザーマニュアルが存在しない
- **ハードコーディング**: ベースライン値がコード内に直接記述

### 推定の根拠

- **強い根拠**: 実装コード + CLAUDE.md記載 + 明確な動作
- **中程度の根拠**: 実装コード + 一般的なベストプラクティス
- **弱い根拠**: 実装のみ、業界標準から推定