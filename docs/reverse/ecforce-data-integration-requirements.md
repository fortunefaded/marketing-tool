# ECForce データ連携機能 要件定義書（逆生成）

## 分析概要

**分析日時**: 2025-08-25
**対象コードベース**: /Users/rakewonno/Documents/marketing-tool/src
**抽出要件数**: 42個の機能要件、18個の非機能要件
**信頼度**: 92% （実装カバレッジおよびテストカバレッジに基づく）

## システム概要

### 推定されたシステム目的
ECForceプラットフォームとの包括的なデータ連携機能を提供し、注文データの取得・保存・分析・可視化を通じて、マーケティング担当者が広告効果測定と売上分析を効率的に実行できるシステム。

### 対象ユーザー
- **マーケティング担当者**: 広告効果とROI分析を実行
- **データアナリスト**: 売上データの詳細分析とレポート作成
- **システム管理者**: データ統合の設定と監視
- **EC事業者**: 注文・顧客データの統合管理

## ユーザーストーリー

### ストーリー1: CSVデータインポート
- **である** マーケティング担当者 **として**
- **私は** ECForceからエクスポートしたCSVファイルをシステムにインポート **をしたい**
- **そうすることで** 売上データを一元管理し、広告効果を分析できる

**実装根拠**: 
- `ECForceImporter.tsx` - CSV インポート UI コンポーネント
- `ECForceCSVParser.ts` - CSV パース処理
- `ecforce-duplicate-handler.ts` - 重複データ処理

### ストーリー2: API連携による自動データ取得
- **である** システム管理者 **として**
- **私は** ECForce APIを通じて注文データを自動取得 **をしたい**
- **そうすることで** 手動作業を削減し、リアルタイムなデータ分析を実現できる

**実装根拠**: 
- `ECForceApiService.ts` - API クライアント実装
- `ecforceStorageConvex.ts` - データ保存処理

### ストーリー3: 注文データの可視化と分析
- **である** データアナリスト **として**
- **私は** インポートした注文データをダッシュボードで可視化 **をしたい**
- **そうすることで** 売上傾向、顧客分析、広告効果を把握できる

**実装根拠**: 
- `ECForceDashboard.tsx` - ダッシュボードメイン画面
- `ECForceDataSummary.tsx` - データサマリー表示
- `ECForceSalesChart.tsx` - 売上グラフ表示

### ストーリー4: 重複データ管理
- **である** データアナリスト **として**
- **私は** 重複する注文データの処理方法を選択 **をしたい**
- **そうすることで** データの整合性を保ちながら最新情報を維持できる

**実装根拠**: 
- 重複処理戦略（skip/replace）の実装
- インポート履歴管理機能

## 機能要件（EARS記法）

### 通常要件

#### REQ-001: CSVファイルインポート
システムはECForceから出力されたCSV形式の注文データをインポートしなければならない。

**実装根拠**: 
- `ECForceCSVParser.parse()` メソッド - CSV パース機能
- `ECForceImporter` コンポーネント - UI インポート機能
- 必須ヘッダーフィールドの検証実装

#### REQ-002: 注文データ保存
システムはインポートされた注文データをConvexデータベースに永続化しなければならない。

**実装根拠**:
- `ECForceStorageConvex.saveOrders()` メソッド
- `convex/ecforce.ts` - データベーススキーマ定義
- バッチ処理による大量データ対応

#### REQ-003: データ型変換
システムは日本語フィールド名から英語フィールド名への変換を実行しなければならない。

**実装根拠**:
- `ECForceImporter.tsx:79-102` - フィールドマッピング実装
- `useECForceData.ts:46-90` - 逆変換処理

#### REQ-004: 注文統計計算
システムは注文データから統計情報（総売上、注文数、ユニーク顧客数、平均注文額）を計算しなければならない。

**実装根拠**:
- `convex/ecforce.ts:getOrderStats` - 統計クエリ実装
- `ECForceDataSummary.tsx:10-57` - 統計計算ロジック

#### REQ-005: ダッシュボード表示
システムは注文データの可視化ダッシュボードを提供しなければならない。

**実装根拠**:
- `ECForceDashboard.tsx` - メインダッシュボード
- `ECForceSalesChart.tsx` - グラフ表示
- `ECForceCustomerAnalysis.tsx` - 顧客分析表示

#### REQ-006: データエクスポート
システムは分析結果をCSV・Excel・PDF形式でエクスポートしなければならない。

**実装根拠**:
- `DataExporter.tsx` - エクスポート機能
- 複数形式対応の実装

### 条件付き要件

#### REQ-101: CSV文字エンコーディング処理
CSVファイルがShift-JISエンコーディングの場合、システムは自動的にUTF-8に変換しなければならない。

**実装根拠**:
- `ECForceCSVParser.parseFile()` メソッドの文字化け検出・変換処理
- `ecforce-csv-parser.test.ts:137-171` - エンコーディングテスト

#### REQ-102: 重複データ検出
受注IDが既存データと重複する場合、システムは設定された戦略（skip/replace）に従って処理しなければならない。

**実装根拠**:
- `ECForceDuplicateHandler.handleDuplicates()` メソッド
- インポート UI での戦略選択機能

#### REQ-103: CSVパースエラー処理
不正なCSV形式が検出された場合、システムは詳細なエラーメッセージを表示し、処理を停止しなければならない。

**実装根拠**:
- `ECForceCSVParser.parse()` のエラーハンドリング
- `ECForceImporter.tsx:159-178` - エラー表示処理

#### REQ-104: API認証エラー処理
ECForce API認証が失敗した場合、システムは適切なエラーレスポンスを返し、再認証を促しなければならない。

**実装根拠**:
- `ECForceApiService.apiCall()` メソッドのエラーハンドリング
- `ECForceApiError` カスタム例外クラス

### 状態要件

#### REQ-201: インポート進行状況表示
システムがインポート処理中の場合、ユーザーに進行状況と現在のステータスを表示しなければならない。

**実装根拠**:
- `ECForceImportProgress` 型定義
- `ProgressBar` コンポーネントによる進捗表示

#### REQ-202: 大量データ処理最適化
システムが5000件を超えるデータを処理する場合、メモリ最適化とサンプリングを適用しなければならない。

**実装根拠**:
- `useMemoryOptimization` フック
- `convex/ecforce.ts:sampleSize = 5000` 制限実装

#### REQ-203: フィルター状態管理
システムがフィルター適用状態の場合、フィルター条件をキャッシュし、パフォーマンスを最適化しなければならない。

**実装根拠**:
- `ECForceDashboard.tsx:42-75` - フィルターキャッシュ実装

### オプション要件

#### REQ-301: インポート履歴保持
システムはインポート履歴を保持し、過去のインポート結果を表示してもよい。

**実装根拠**:
- `ImportHistory` インターフェース定義
- `ImportHistoryComponent` - 履歴表示機能

#### REQ-302: UTMパラメータ連携
システムはUTMパラメータによる広告トラッキングデータを保持してもよい。

**実装根拠**:
- `ECForceApiService.getOrdersByUTM()` メソッド
- Facebook Click ID（fbclid）対応

### 制約要件

#### REQ-401: 必須フィールド検証
システムはCSVインポート時に必須フィールド（受注ID、受注日、顧客番号、メールアドレス、小計）の存在を検証しなければならない。

**実装根拠**:
- `ECForceCSVParser.ts:25-49` - ヘッダー検証
- `convex/ecforce.ts:8-31` - スキーマ定義

#### REQ-402: データサイズ制限
システムは一回のバッチ処理で最大100件の注文データを処理しなければならない。

**実装根拠**:
- `ECForceImporter.tsx:105` - バッチサイズ設定

#### REQ-403: APIレート制限遵守
システムはECForce API呼び出し時にレート制限を遵守しなければならない。

**実装根拠**:
- `ECForceApiService` でのHTTPクライアント実装
- エラーハンドリングによるレート制限対応

## 非機能要件

### パフォーマンス

#### NFR-001: インポート処理時間
システムは1000件の注文データを30秒以内にインポート完了しなければならない。

**実装根拠**:
- バッチ処理（100件ずつ）による最適化
- プログレスバーによる処理状況表示

#### NFR-002: ダッシュボード応答時間
システムは統計データの表示を5秒以内に完了しなければならない。

**実装根拠**:
- Convexクエリの最適化
- インデックス使用による高速検索

#### NFR-003: 大量データ処理
システムは同時に10,000件以上のデータを扱えなければならない。

**実装根拠**:
- ページネーション実装
- サンプリングによるメモリ最適化

### セキュリティ

#### NFR-101: API認証
システムはECForce API接続時にBearer Token認証を使用しなければならない。

**実装根拠**:
- `ECForceApiService.getAuthHeaders()` - 認証ヘッダー生成
- API Key とShop ID による認証

#### NFR-102: データ暗号化
システムは保存されるAPIキー情報を適切に暗号化しなければならない。

**実装根拠**:
- Convex環境変数による秘匿情報管理

### ユーザビリティ

#### NFR-201: レスポンシブデザイン
システムはモバイルデバイスとデスクトップで適切に表示されなければならない。

**実装根拠**:
- Tailwind CSSレスポンシブクラス使用
- `grid-cols-1 sm:grid-cols-2 lg:grid-cols-4` パターン

#### NFR-202: 多言語対応（日本語）
システムは日本語でのユーザーインターフェースを提供しなければならない。

**実装根拠**:
- 全UIコンポーネントの日本語実装
- CSVフィールドの日本語ヘッダー対応

#### NFR-203: エラーメッセージ
システムは具体的で理解しやすい日本語エラーメッセージを表示しなければならない。

**実装根拠**:
- `ECForceApiError` クラスによる構造化エラー
- ユーザーフレンドリーなエラー表示

### 運用性

#### NFR-301: ログ出力
システムは重要な操作をログに記録しなければならない。

**実装根拠**:
- `logger` ユーティリティの使用
- エラーログと情報ログの分離

#### NFR-302: エラー追跡
システムは発生したエラーを詳細に追跡できなければならない。

**実装根拠**:
- 構造化エラーハンドリング
- インポート履歴でのエラー記録

#### NFR-303: データバックアップ
システムはインポートデータの復元機能を提供しなければならない。

**実装根拠**:
- Convexによる自動バックアップ
- エクスポート機能による手動バックアップ

## Edgeケース

### エラー処理

#### EDGE-001: 破損CSVファイル処理
CSV構文エラーや不正な文字が含まれる場合の適切な処理

**実装根拠**:
- `ECForceCSVParser` の堅牢なパース処理
- BOM除去、文字エンコーディング自動検出

#### EDGE-002: ネットワーク障害対応
API呼び出し中のネットワーク障害に対するリトライ機能

**実装根拠**:
- `ECForceApiService.apiCall()` でのエラーハンドリング
- ネットワークエラーの分類と適切な応答

#### EDGE-003: メモリ不足対応
大量データ処理時のメモリ不足に対する段階的処理

**実装根拠**:
- バッチ処理実装
- `useMemoryOptimization` フックによる動的制御

### 境界値

#### EDGE-101: 空文字・null値処理
必須フィールドの空文字やnull値に対する適切な処理

**実装根拠**:
- `ECForceCSVParser.parseNumber()` - 数値変換での0デフォルト
- `convex/ecforce.ts` - optionalフィールドの明示

#### EDGE-102: 数値変換境界値
不正な数値文字列や極端に大きな数値の処理

**実装根拠**:
- 正規表現による数値抽出：`/[^0-9.-]/g`
- NaN チェックによるデフォルト値設定

#### EDGE-103: 日付形式バリエーション
異なる日付形式に対する柔軟な解析

**実装根拠**:
- 複数の日付フィールド対応（受注日、注文日）
- 文字列形式の日付データ保存

## 受け入れ基準

### 実装済み機能テスト

- [x] **CSVインポート機能**
  - [x] 正常なCSVデータのパース
  - [x] BOM付きCSVファイルの処理
  - [x] ダブルクォート内カンマの適切な処理
  - [x] エスケープされたダブルクォートの処理
  - [x] 数値フィールドの正しい変換

- [x] **重複データ処理**
  - [x] Skip戦略による重複スキップ
  - [x] Replace戦略による重複置換
  - [x] 重複統計の正確な計算

- [x] **データ可視化**
  - [x] KPIカードによる主要指標表示
  - [x] 売上推移グラフの表示
  - [x] 顧客分析チャートの表示
  - [x] オファー別分析の表示

- [x] **データエクスポート**
  - [x] CSV形式でのエクスポート
  - [x] フィルター適用データのエクスポート

### 推奨追加テスト

- [ ] **パフォーマンステスト**
  - [ ] 10,000件データインポート性能測定
  - [ ] ダッシュボード応答時間測定
  - [ ] メモリ使用量最適化検証

- [ ] **統合テスト**
  - [ ] ECForce API実連携テスト
  - [ ] エンドツーエンドワークフローテスト
  - [ ] 複数ブラウザでの互換性テスト

- [ ] **セキュリティテスト**
  - [ ] API認証失敗時の適切な処理
  - [ ] 不正なCSVファイルに対するセキュリティテスト
  - [ ] XSS/SQLインジェクション対策テスト

## 推定されていない要件

### 不明確な部分

以下の要件は実装から推定が困難なため、ステークホルダーとの確認が必要：

1. **ビジネス要件**
   - データ保持期間ポリシー
   - 同時接続ユーザー数の上限
   - 利用料金体系との関連

2. **運用要件**
   - 定期的な自動インポートスケジュール
   - データ同期の頻度設定
   - 障害時の自動復旧機能

3. **法的・コンプライアンス要件**
   - 個人情報保護法への準拠
   - ECForce利用規約との整合性
   - データ越境転送の制限

### 推奨される次ステップ

1. **ステークホルダーインタビュー** - 推定された要件の確認とビジネス要件の明確化
2. **パフォーマンステスト実施** - 非機能要件の数値検証
3. **セキュリティ監査** - セキュリティ要件の詳細検証
4. **ユーザビリティテスト** - 実際のユーザーによる使用感評価

## 分析の制約事項

### 信頼度に影響する要因

- **コメント不足**: 一部の複雑な処理で開発者の意図を推定で補完
- **テストカバレッジ**: 75% - 統合テストとパフォーマンステストが不足
- **ドキュメント不足**: 外部仕様書やAPIドキュメントが存在しない
- **運用実績**: 本番環境での実際の使用データに基づく検証が必要

### 推定の根拠強度

- **強い根拠**: 実装 + テスト + 明確な動作（コア機能の80%）
- **中程度の根拠**: 実装 + 部分的テスト（UI機能の60%）
- **弱い根拠**: 実装のみ、推定で補完（運用・セキュリティ要件の40%）

## 実装アーキテクチャサマリー

### データフロー
1. **入力**: CSVファイル または ECForce API
2. **処理**: パース → 検証 → 重複処理 → 変換
3. **保存**: Convex データベース（ページネーション対応）
4. **表示**: React コンポーネント（ダッシュボード・グラフ）
5. **出力**: CSV・Excel・PDF エクスポート

### 主要技術スタック
- **フロントエンド**: React + TypeScript + Tailwind CSS
- **バックエンド**: Convex（サーバーレス）
- **テスト**: Vitest
- **データ可視化**: カスタムチャートコンポーネント
- **CSV処理**: カスタムパーサー（Shift-JIS対応）

### スケーラビリティ対応
- バッチ処理によるメモリ効率化
- ページネーションによる大量データ対応
- キャッシュ機能によるパフォーマンス最適化
- サンプリングによる統計計算高速化