# Meta API データ集約 アーキテクチャ設計

## システム概要

Meta広告APIから取得した生データ（日別・プラットフォーム別に分割された最大90行/広告）を階層的データ構造に集約し、時系列分析と疲労度計算を行うシステム。React + TypeScript環境で動作し、Convexをデータストアとして使用する。

## アーキテクチャパターン

- **パターン**: レイヤードアーキテクチャ + パイプライン処理
- **理由**: 
  - データ変換の段階が明確（Raw → Aggregated → Analyzed）
  - 各層の責務が明確で、保守性が高い
  - 既存システムへの影響を最小限に抑えられる

## システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                     プレゼンテーション層                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  FatigueDashboard │ CreativeTable │ Charts           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                        アプリケーション層                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  useAdFatigue Hook │ useMetaApiFetcher │ State Mgmt  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                         ビジネスロジック層                     │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ AdDataAggregator │ FatigueTimelineCalculator         │  │
│  │ MetricsCalculator │ DataValidator                    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                          データアクセス層                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ SimpleMetaApi │ ConvexDataCache │ LocalCache         │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────┐
│                           外部システム                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │   Meta Marketing API   │   Convex Database           │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## コンポーネント構成

### フロントエンド
- **フレームワーク**: React 18 + TypeScript 5
- **状態管理**: 
  - ローカル状態: React Hooks (useState, useReducer)
  - グローバル状態: Context API
  - サーバー状態: Convex Real-time Sync
- **UIライブラリ**: Tailwind CSS + Headless UI
- **グラフ**: Recharts / Chart.js
- **パフォーマンス最適化**:
  - React.memo による不要な再レンダリング防止
  - useMemo/useCallback による計算結果のキャッシュ
  - 仮想スクロールによる大量データの効率的表示

### データ処理層
- **アグリゲーター**: AdDataAggregator クラス
  - 3階層Map構造による効率的なグループ化
  - ストリーミング処理による省メモリ実装
- **疲労度計算**: FatigueTimelineCalculator クラス
  - 移動平均による時系列分析
  - 閾値ベースの状態判定
- **バリデーション**: DataValidator クラス
  - スキーマベースの入力検証
  - 異常値の自動検出と補正

### データアクセス層
- **Meta API クライアント**: SimpleMetaApi クラス
  - レート制限対応（指数バックオフ）
  - バッチ処理による効率的なデータ取得
  - エラーハンドリングとリトライロジック
- **キャッシュ戦略**:
  - L1キャッシュ: メモリ内キャッシュ（LRU, 100MB）
  - L2キャッシュ: Convex永続化ストレージ
  - キャッシュ有効期限: 1時間（設定可能）

### データベース
- **DBMS**: Convex（リアルタイムデータベース）
- **スキーマ設計**: 
  - 正規化されたインサイトテーブル
  - 集約済みパフォーマンステーブル
  - 疲労度時系列テーブル
- **インデックス戦略**:
  - ad_id + date_range の複合インデックス
  - campaign_id, adset_id の単一インデックス

## データ処理パイプライン

```
Raw Insights (90,000行)
    ↓
[Stage 1: Validation]
  - スキーマ検証
  - 異常値検出
    ↓
[Stage 2: Aggregation]
  - ad_idによるグルーピング
  - 日別・プラットフォーム別集約
    ↓
[Stage 3: Calculation]
  - サマリーメトリクス計算
  - 比率再計算
    ↓
[Stage 4: Analysis]
  - 疲労度スコア計算
  - トレンド分析
    ↓
Structured Data (1,000行)
```

## エラーハンドリング戦略

### APIレベル
- レート制限: 指数バックオフによる自動リトライ
- タイムアウト: 段階的な期間短縮による再取得
- 部分的失敗: 成功したデータのみ処理続行

### データレベル
- 欠損値: デフォルト値による補完
- 異常値: 警告ログ出力 + 閾値によるクリッピング
- 重複データ: 最新タイムスタンプを優先

### UIレベル
- ローディング状態: スケルトンスクリーン
- エラー状態: ユーザーフレンドリーなメッセージ
- 部分的成功: 利用可能なデータで表示続行

## スケーラビリティ考慮事項

### 現在の制限
- 最大処理行数: 90,000行
- 最大広告数: 1,000件
- 処理時間目標: 3秒以内

### 将来の拡張性
- Web Worker による並列処理対応
- ページネーションによる段階的読み込み
- インクリメンタル更新による差分処理
- GraphQL導入による効率的なデータ取得

## セキュリティ考慮事項

### 認証・認可
- Meta API: OAuth 2.0によるトークン管理
- Convex: ロールベースアクセス制御

### データ保護
- APIトークンの暗号化保存
- HTTPSによる通信暗号化
- 機密情報のマスキング（ログ出力時）

## 技術スタック

### 必須依存関係
- React 18.2+
- TypeScript 5.0+
- Convex 1.6+
- Meta Marketing API v23.0

### 開発ツール
- Vite（ビルドツール）
- ESLint + Prettier（コード品質）
- Vitest（テストフレームワーク）

## デプロイメント構成

### 環境
- 開発環境: localhost:3000
- ステージング: Vercel Preview
- 本番環境: Vercel Production

### 環境変数
```env
VITE_META_API_VERSION=v23.0
VITE_CONVEX_URL=https://xxx.convex.cloud
VITE_LOG_LEVEL=info
VITE_CACHE_TTL=3600
```

## モニタリング

### メトリクス
- データ処理時間
- メモリ使用量
- API呼び出し回数
- エラー発生率

### ロギング
- アプリケーションログ: vibelogger
- エラートラッキング: Sentry（オプション）
- パフォーマンス: Web Vitals

---

作成日: 2025-08-27
バージョン: 1.0.0