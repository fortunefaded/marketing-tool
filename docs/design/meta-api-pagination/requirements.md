# Meta API 正しいデータ取得システム - 簡潔版要件定義

## 概要

Meta APIから30日分の広告データを要求しても、実際には各広告の配信日のみのデータ（1-6日分）が返却されている問題を解決する。

**目的**: APIから**正しく全データを取得**し、**実態を透明に表示**する。

## 問題の定義

- 要求: 30日分のデータ
- 実際: 1-6日分のデータのみ返却
- 原因: ページネーション未実装 or Meta API仕様制限

## 解決すべき3つのコア機能

### 1. 完全ページネーション実装
- `response.paging.next` が存在する限り全ページを取得
- 取得漏れを完全に防ぐ

### 2. 実配信日数の正確把握
- 各広告の実際の配信日数を表示
- 「X日/30日配信」の透明な表示

### 3. 基本エラーハンドリング
- API失敗時の適切な対応
- ネットワーク問題への対処

## 機能要件（EARS記法）

### 通常要件
- **REQ-001**: システムは、response.paging.nextが存在する限り全ページを取得しなければならない
- **REQ-002**: システムは、各広告の実配信日数を正確に算出・表示しなければならない  
- **REQ-003**: システムは、取得したページ数とデータ件数をログ出力しなければならない
- **REQ-004**: システムは、APIエラー時に3回まで自動リトライしなければならない

### 条件付き要件
- **REQ-101**: maxPagesパラメータが指定された場合、システムは指定ページ数で処理を停止しなければならない
- **REQ-102**: APIレスポンスが異常な場合、システムは取得済みデータを保持し処理を継続しなければならない

## 非機能要件

### パフォーマンス
- **NFR-001**: 全データ取得を30秒以内に完了すること
- **NFR-002**: Meta API レート制限（200コール/時間）を遵守すること

### 信頼性
- **NFR-101**: 取得データの正確性を保証すること
- **NFR-102**: ネットワーク障害時も部分データを保持すること

## 実装対象

### 修正ファイル
1. `src/features/meta-api/core/api-client.ts`
   - `fetchPaginatedData` メソッドの完全実装
   - 全ページ取得ロジック追加
   - エラーハンドリング強化

2. UIコンポーネントの表示改善
   - 実配信日数の表示追加
   - 「X日/30日配信」ラベル表示

## 除外する機能（複雑性排除）

- ❌ 学習アルゴリズム
- ❌ 動的最適化  
- ❌ 複雑なキャッシュ戦略
- ❌ タイムラインビュー
- ❌ 予測機能
- ❌ A/Bテスト分析

## 受け入れ基準

### 基本テスト
- [ ] 30日間のデータが全ページから漏れなく取得できること
- [ ] 各広告の実配信日数が正しく表示されること  
- [ ] ページネーション処理が最後まで動作すること
- [ ] APIエラー時のリトライが正常に動作すること

### 表示テスト
- [ ] 「X日/30日配信」ラベルが適切に表示されること
- [ ] 取得ページ数がログ出力されること
- [ ] データ件数が正しく表示されること

## 実装チェックリスト

### src/features/meta-api/core/api-client.ts
- [ ] `fetchPaginatedData` の全ページ取得ロジック実装
- [ ] `while (response.paging?.next)` による完全ページネーション
- [ ] API呼び出し回数のログ出力
- [ ] エラーハンドリングとリトライ処理
- [ ] レート制限対応

### UIコンポーネント
- [ ] 実配信日数表示の追加
- [ ] 配信率（X日/30日）の表示
- [ ] 取得状況の表示改善

## 検証手順

1. **基本動作確認**
   - 開発環境で30日間のデータ全取得を実行
   - コンソールログでページネーション動作を確認
   - 各広告の実配信日数を確認

2. **異常系テスト**  
   - ネットワーク切断時の動作
   - APIトークン無効時の動作
   - レート制限到達時の動作

## 成功指標

- ✅ 30日分のデータ取得漏れ 0%
- ✅ 実配信日数表示の正確性 100%  
- ✅ API呼び出し成功率 95%以上
- ✅ エラー発生時の復旧率 90%以上

---

**この要件定義は、複雑性を排除し「正しいデータ取得」のみにフォーカスした最小実装を目指します。**