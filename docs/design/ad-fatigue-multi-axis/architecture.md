# Ad Fatigue 多軸表示機能 アーキテクチャ設計

## システム概要

現在の広告疲労度分析機能を拡張し、広告クリエイティブ単位だけでなく、広告セット・キャンペーン単位での分析を可能にする。既存のReactコンポーネントアーキテクチャを維持しながら、データ集約層を追加して多軸表示を実現する。

## アーキテクチャパターン

- **パターン**: レイヤードアーキテクチャ + コンポーネントベース
- **理由**: 
  - 既存システムとの整合性を保ちつつ段階的な拡張が可能
  - データ集約ロジックを独立したレイヤーとして実装できる
  - UIコンポーネントの再利用性が高い

## コンポーネント構成

### フロントエンド
- **フレームワーク**: React 18 with TypeScript
- **状態管理**: 
  - ローカル状態: React useState/useReducer
  - データフェッチ: カスタムフック（useAdFatigue拡張）
  - タブ状態: URLパラメータまたはローカルストレージ
- **UIライブラリ**: Tailwind CSS (既存)
- **アイコン**: Heroicons (既存)

### データ層
- **API通信**: 既存のSimpleMetaApiクラスを拡張
- **データ変換**: 新規AggregatorServiceクラス
- **キャッシュ**: ConvexまたはインメモリキャッシュでMeta APIレスポンスを保持
- **型安全性**: TypeScript型定義による厳格な型チェック

### 集約サービス
- **責務分離**:
  - `AdSetAggregator`: 広告セット単位の集計
  - `CampaignAggregator`: キャンペーン単位の集計
  - `MetricsCalculator`: 各種メトリクス計算（CPA, CTR, CVR等）

## データフロー

1. **Meta API → Raw Data**: 広告クリエイティブレベルのデータ取得
2. **Raw Data → Aggregation**: 表示軸に応じたデータ集約
3. **Aggregation → UI State**: 集約データのUI状態への反映
4. **UI State → Components**: タブ切り替えによる表示更新

## 主要な設計判断

### 1. 既存コンポーネントの拡張
- `FatigueDashboard`コンポーネントにタブ機能を追加
- `FatigueAccordion`を全表示軸で再利用
- 新規`TabNavigation`コンポーネントの作成

### 2. データ構造の拡張
- `FatigueData`型は維持（クリエイティブ用）
- 新規`AdSetFatigueData`型（広告セット用）
- 新規`CampaignFatigueData`型（キャンペーン用）
- 共通インターフェース`BaseFatigueData`の導入

### 3. パフォーマンス最適化
- 集約計算のメモ化（useMemo）
- 仮想スクロール（大量データ対応）
- 遅延ローディング（タブ切り替え時）

### 4. エラーハンドリング
- 各レイヤーでのエラーバウンダリ
- フォールバックUI（データ不足時）
- リトライメカニズム

## セキュリティ考慮事項

- Meta APIトークンの安全な管理（既存のTokenStore利用）
- クライアントサイドでの集計によるデータ漏洩なし
- XSS対策（React標準のエスケープ処理）

## 拡張性

- 新しい表示軸の追加が容易（インターフェース準拠）
- メトリクス追加が集約サービスの拡張で対応可能
- 将来的なグラフ表示機能の追加を考慮した設計