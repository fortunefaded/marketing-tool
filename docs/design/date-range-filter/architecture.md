# 日付範囲フィルター機能 アーキテクチャ設計

## システム概要

Meta広告疲労度ダッシュボードにおける日付範囲フィルター機能は、ユーザーが選択した期間のデータをMeta Graph API v23.0から取得し、集約・表示するシステムです。React/TypeScriptベースのフロントエンドとMeta APIとの通信を最適化し、高速なデータ表示を実現します。

## アーキテクチャパターン

- **パターン**: レイヤードアーキテクチャ + React Hooks パターン
- **理由**: 
  - 責務の明確な分離により保守性を向上
  - Reactのカスタムフックによる状態管理の抽象化
  - データフローの単一方向性により予測可能な動作を実現

## 技術スタック

### フロントエンド
- **フレームワーク**: React 18.x + TypeScript 5.x
- **状態管理**: React Hooks (useState, useEffect, useCallback, useMemo)
- **UIライブラリ**: Tailwind CSS
- **データフェッチ**: カスタムフックベースのAPI通信層
- **キャッシュ**: localStorage + メモリキャッシュ

### バックエンド
- **API通信**: Meta Graph API v23.0 直接接続
- **認証方式**: OAuth 2.0 (Meta Business SDK)
- **トークン管理**: Convex + SimpleTokenStore

### データ層
- **外部API**: Meta Graph API v23.0
- **ローカルキャッシュ**: localStorage (日付範囲ごとに分離)
- **セッションストレージ**: 一時的なデータ保持

## コンポーネント構成

### プレゼンテーション層

```
DateRangeFilter (UI Component)
├── ドロップダウンメニュー
├── 選択状態表示
└── ローディング表示
```

### コンテナ層

```
FatigueDashboardContainer
├── 日付範囲状態管理
├── データフェッチ制御
└── 子コンポーネントへのデータ配信
```

### フック層

```
useAdFatigueSimplified
├── useMetaInsights (API通信)
├── useFatigueCalculation (疲労度計算)
├── useCreativeEnrichment (データ拡張)
└── useLocalCache (キャッシュ管理)
```

### API通信層

```
SimpleMetaApi
├── getTimeSeriesInsights (時系列データ取得)
├── getPlatformBreakdown (プラットフォーム別データ)
└── fetchInsightsContinuation (ページング処理)
```

## データフロー

1. **ユーザーインタラクション**
   - DateRangeFilterコンポーネントで日付範囲を選択
   
2. **状態更新**
   - FatigueDashboardContainerで状態を管理
   - 選択された日付範囲をフックに伝播

3. **データ取得**
   - useMetaInsightsフックがAPI呼び出しを実行
   - キャッシュチェック → 未キャッシュならAPIコール

4. **データ処理**
   - 時系列データの集約（同一クリエイティブ名でグループ化）
   - 疲労度スコアの計算

5. **表示更新**
   - 処理済みデータをテーブルに表示
   - ローディング/エラー状態の管理

## キャッシュ戦略

### キャッシュキー構造
```
meta-insights-cache-{accountId}-{dateRange}-{timestamp}
```

### キャッシュポリシー
- **有効期限**: 1時間
- **最大サイズ**: 10MB per アカウント
- **削除戦略**: LRU (Least Recently Used)

### キャッシュ階層
1. **メモリキャッシュ** (React state) - 即座にアクセス可能
2. **localStorage** - ページリロード後も保持
3. **API呼び出し** - キャッシュミス時のフォールバック

## エラーハンドリング

### エラー分類

1. **ネットワークエラー**
   - 自動リトライ（最大3回）
   - エクスポネンシャルバックオフ

2. **認証エラー**
   - トークンリフレッシュ
   - 再認証フローへの誘導

3. **レート制限**
   - Retry-Afterヘッダーに基づく待機
   - 部分データの表示

4. **データエラー**
   - グレースフルデグラデーション
   - デフォルト値へのフォールバック

## パフォーマンス最適化

### 初期表示の高速化
- **プログレッシブレンダリング**: 取得済みデータから順次表示
- **仮想スクロール**: 大量データの効率的表示
- **メモ化**: 計算結果のキャッシュ

### API通信の最適化
- **バッチリクエスト**: 複数リクエストの統合
- **ページング**: 最大500件/リクエスト
- **並列処理**: 独立したデータの同時取得

### レンダリング最適化
- **React.memo**: 不要な再レンダリング防止
- **useMemo/useCallback**: 関数・値の再計算防止
- **コード分割**: 動的インポートによる初期バンドルサイズ削減

## セキュリティ考慮事項

### 認証・認可
- OAuth 2.0トークンの安全な管理
- トークンの定期的なローテーション
- スコープの最小権限原則

### データ保護
- APIトークンのマスキング（ログ出力時）
- HTTPSによる通信の暗号化
- XSS対策（データサニタイゼーション）

### アクセス制御
- アカウントごとのデータ分離
- ユーザー権限チェック
- 監査ログの記録

## スケーラビリティ

### 水平スケーリング
- ステートレスな設計
- CDNによる静的アセットの配信
- API Gateway経由での負荷分散

### 垂直スケーリング
- Web Workerによる重い計算の並列処理
- IndexedDBによる大容量データの保存
- Service Workerによるオフライン対応

## 監視・ログ

### メトリクス
- API応答時間
- エラー率
- キャッシュヒット率

### ログレベル
- ERROR: システムエラー
- WARN: 警告（レート制限等）
- INFO: 重要なイベント
- DEBUG: デバッグ情報

### アラート条件
- API応答時間 > 5秒
- エラー率 > 1%
- キャッシュヒット率 < 50%

## 将来の拡張性

### 計画中の機能
- カスタム日付範囲の選択
- 複数期間の比較表示
- データエクスポート機能
- リアルタイムデータ更新

### 技術的改善
- GraphQLへの移行検討
- WebSocketによるリアルタイム通信
- Progressive Web App化
- 機械学習による予測分析

---

*作成日: 2024年12月*
*バージョン: 1.0*
*次回レビュー: 2025年1月*