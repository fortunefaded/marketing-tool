# 広告疲労度スコアリングシステム 技術設計書

## 概要

動画クリエイティブの広告疲労度を3つの指標（クリエイティブ疲労・視聴者疲労・アルゴリズム疲労）で総合的にスコアリング（0-100）し、Meta広告とECforceの数値を集約して、画像・動画・テキストごとの成果を自動集計・横断表示するシステムの技術設計書です。

## 絶対達成目標

✅ **Meta広告, ECforceの数値を集約**  
✅ **画像・動画・テキストごとの成果を自動集計**  
✅ **MetaのAPIで引っ張れる情報をキャンペーンとクリエイティブ単位で集計して表示**  
✅ **ROAS／CPA／CVなどのKPIを横断表示**  
✅ **APIまたはCSVでの自動データ取得**  
✅ **広告主・媒体・キャンペーン単位の成果比較が可能**

## 設計文書構成

| ファイル | 説明 | 主要内容 |
|----------|------|----------|
| [architecture.md](./architecture.md) | システムアーキテクチャ設計 | DDD+イベント駆動、4層構造、疲労度計算エンジン |
| [dataflow.md](./dataflow.md) | データフロー図 | 8つのMermaidフロー図、処理プロセス可視化 |
| [interfaces.ts](./interfaces.ts) | TypeScript型定義 | 500行超の包括的型定義、全機能カバー |
| [database-schema.sql](./database-schema.sql) | データベーススキーマ | Meta/ECforce統合、KPI集約、疲労度分析用テーブル |
| [api-endpoints.md](./api-endpoints.md) | API仕様書 | 疲労度分析、KPI集約、Meta/ECforce統合API |

## 主要機能アーキテクチャ

### 1. 疲労度スコアリングエンジン
```
Meta APIデータ → ベースライン計算 → 3つの疲労指標計算 → 総合スコア算出
├── クリエイティブ疲労: CTR低下率ベース（重み40%）
├── 視聴者疲労: Frequency基準（重み35%）
└── アルゴリズム疲労: CPM上昇率ベース（重み25%）
```

### 2. データ集約・統合システム
```
Meta Marketing API ──┐
Instagram Insights ──┤── データ統合層 ──┐
ECforce API ─────────┤                  ├── KPI計算エンジン → ダッシュボード
CSV Import ──────────┘                  │
                                        └── 横断比較分析
```

### 3. クリエイティブ種別分析
```
広告データ → 種別分類 → パフォーマンス集計 → 比較分析
├── 動画広告: 視聴率、エンゲージメント重視
├── 画像広告: CTR、コンバージョン重視  
├── テキスト広告: クリック効率重視
└── カルーセル広告: 総合パフォーマンス評価
```

## 技術スタック

### フロントエンド
- **フレームワーク**: React 18 + TypeScript
- **状態管理**: Zustand (疲労度データ) + Convex Hooks
- **UI**: Tailwind CSS + Heroicons
- **可視化**: Recharts (疲労度トレンド、KPI比較)

### バックエンド  
- **フレームワーク**: Convex (TypeScript)
- **データベース**: Convex Database (Document Store)
- **バッチ処理**: Convex Scheduled Functions
- **API統合**: Convex HTTP Actions

### 外部統合
- **Meta Marketing API**: v18.0 (基本メトリクス)
- **Instagram Insights API**: v18.0 (特有メトリクス)
- **ECforce API**: オーダー・顧客データ
- **認証**: OAuth2 + Convex Auth

## 主要設計特徴

### パフォーマンス要件達成
- **疲労度計算**: 200ms/クリエイティブ以内
- **バッチ処理**: 100件30秒以内、最大10並行処理  
- **キャッシュ戦略**: 計算結果24時間キャッシュ
- **データ品質**: 専門家判定80%以上の一致率

### スケーラビリティ設計
- **優先度処理**: 広告費用順での処理優先付け
- **分割処理**: 大量データの段階的処理
- **エラーハンドリング**: 部分失敗時の継続処理
- **フォールバック**: API障害時のキャッシュ利用

### データ統合戦略
- **統一データモデル**: Meta/ECforceデータの正規化
- **アトリビューション**: 広告クリックと売上の紐付け
- **リアルタイム同期**: Convex Subscriptionsでのデータ更新
- **データ品質管理**: 異常値検出・補正機能

## 実装フェーズ

### Phase 1: コア疲労度計算（高優先度）
- Meta APIデータ取得・ベースライン計算
- 3つの疲労指標算出アルゴリズム  
- 総合スコア計算・状態判定
- 基本UI表示

### Phase 2: データ統合・KPI集約（高優先度）
- ECforceデータインポート機能
- クリエイティブ種別分析
- ROAS/CPA/CV横断表示
- キャンペーン・アカウント比較

### Phase 3: 高度な分析機能（中優先度）
- Instagram特有メトリクス統合
- アトリビューション分析
- トレンド分析・予測機能
- アラート・通知システム

### Phase 4: UX・運用改善（低優先度）
- 高度な可視化機能
- カスタムレポート機能
- A/Bテスト推奨機能
- パフォーマンス最適化

## KPI・成功指標

### 機能品質
- **疲労度精度**: 専門家判定との一致率 ≥ 80%
- **処理性能**: 200ms/クリエイティブ、30秒/100件
- **データ統合精度**: Meta↔ECforce紐付け率 ≥ 85%
- **可用性**: システム稼働率 ≥ 99.5%

### ユーザビリティ
- **直感性**: 初回利用者のスコア理解率 ≥ 90%  
- **効率性**: KPI比較作業時間50%短縮
- **満足度**: ユーザー評価 ≥ 4.0/5.0

### ビジネス価値
- **意思決定速度**: 疲労度判断時間80%短縮
- **広告効果**: ROAS改善率 ≥ 15%
- **コスト効率**: 無駄広告費削減率 ≥ 20%

## 運用・監視

### 品質監視
- 疲労度計算精度の継続監視
- API統合状況のリアルタイム監視
- データ品質スコアの追跡

### パフォーマンス監視  
- 処理時間・スループットの監視
- メモリ・CPU使用率の追跡
- エラー率・復旧時間の測定

### ビジネス監視
- ユーザー利用状況の分析
- 機能別使用率の追跡
- ROI・効果測定の継続実施

## 次のステップ

この技術設計書に基づき、以下の順序で実装を進めます：

1. **要件承認**: ステークホルダーによる設計レビュー
2. **タスク分解**: 実装タスクの詳細化・優先度付け  
3. **プロトタイプ**: コア機能のPoC実装
4. **段階実装**: Phase別の順次実装・テスト
5. **統合テスト**: 全機能統合・品質確認
6. **本番リリース**: 段階的ロールアウト

各フェーズでユーザーフィードバックを収集し、継続的な改善を行います。