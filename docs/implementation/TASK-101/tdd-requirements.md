# TASK-101: 完全ページネーション処理 - 詳細要件定義

## 概要
Meta APIから30日分のデータを要求した際に、実際の配信日（1-6日）のみ返される問題を解決するため、`response.paging.next`が存在する限り全ページを取得する完全なページネーション処理を実装する。

## 機能要件

### F-101-01: 基本ページネーション処理
**要件**: `while (response.paging?.next)`ループによる全ページ取得
- Meta APIレスポンスの`paging.next`URLを使用して次ページを取得
- ページが存在する限り取得を継続
- 各ページのデータを配列に蓄積
- 最終的に全データを統合して返却

**受け入れ基準**:
- [ ] `fetchPaginatedData`関数が実装されている
- [ ] `paging.next`が存在する限りループが継続される
- [ ] 全ページのデータが正しく結合される
- [ ] 最後のページで正常に終了する

### F-101-02: 進捗トラッキング
**要件**: リアルタイムでの取得進捗表示
- 現在のページ数 / 総ページ数の表示
- 取得済みアイテム数の表示
- 推定残り時間の計算
- 進捗率（0-100%）の算出

**受け入れ基準**:
- [ ] `onProgress`コールバック関数が実装されている
- [ ] 各ページ取得後に進捗が更新される
- [ ] 進捗情報に必要な情報が含まれる（page/total, items, %)
- [ ] 推定残り時間が合理的に算出される

### F-101-03: エラーハンドリング
**要件**: 堅牢なエラー処理とリトライ機能
- ネットワークエラー時の自動リトライ（最大3回）
- レート制限（429エラー）時の指数バックオフ待機
- 部分的成功の処理（一部ページ取得済み）
- 詳細なエラーログ出力

**受け入れ基準**:
- [ ] ネットワークエラー時に最大3回リトライされる
- [ ] 429エラー時に適切な待機時間後リトライされる
- [ ] 部分取得データも保持される
- [ ] エラー詳細がログに記録される

### F-101-04: レート制限対応
**要件**: Meta APIのレート制限を遵守した取得
- 1時間あたり200回の制限を監視
- レート制限近接時の待機処理
- レート制限状況の透明な表示
- 効率的なAPI呼び出しスケジューリング

**受け入れ基準**:
- [ ] レート制限カウンターが実装されている
- [ ] 制限近接時に自動で待機される
- [ ] レート制限状況がユーザーに表示される
- [ ] API呼び出しが効率的にスケジューリングされる

### F-101-05: パフォーマンス最適化
**要件**: 大量データの効率的な取得と処理
- メモリ効率的なデータ蓄積
- 並行取得の制限（最大5リクエスト）
- 不要なデータの早期フィルタリング
- キャンセル可能な処理

**受け入れ基準**:
- [ ] メモリ使用量が合理的範囲内（<100MB）
- [ ] 並行リクエスト数が5以下に制限される
- [ ] 処理のキャンセルが可能
- [ ] 大量データ（100ページ以上）でも安定動作

## 非機能要件

### N-101-01: パフォーマンス
- **応答時間**: 1ページあたり平均2秒以内
- **スループット**: 100ページの取得を10分以内
- **メモリ**: 100ページ取得時のメモリ使用量100MB以下
- **同時実行**: 最大5つの並行API呼び出し

### N-101-02: 信頼性
- **エラー回復**: 一時的なネットワークエラーから自動回復
- **データ整合性**: 取得データの欠損防止
- **冪等性**: 同じリクエストの重複実行でも結果が一致
- **障害耐性**: 部分的な障害でも続行可能

### N-101-03: 使いやすさ
- **進捗表示**: リアルタイムでの詳細進捗
- **キャンセル**: ユーザーによる処理中断
- **透明性**: API呼び出し状況の可視化
- **デバッグ**: 詳細なログ出力

## 技術仕様

### T-101-01: インターフェース定義
```typescript
interface PaginationOptions {
  maxPages?: number
  retryAttempts?: number
  retryDelayMs?: number
  onProgress?: (status: PaginationProgress) => void
  onError?: (error: PaginationError) => void
  signal?: AbortSignal
}

interface PaginationProgress {
  currentPage: number
  totalPages: number
  itemsRetrieved: number
  estimatedCompletion: number
  rateLimitRemaining: number
}

interface PaginationResult<T> {
  data: T[]
  metadata: PaginationMetadata
  deliveryAnalysis: DeliveryAnalysis
}
```

### T-101-02: エラー分類
```typescript
type PaginationErrorType = 
  | 'network'      // ネットワーク接続エラー
  | 'auth'         // 認証エラー
  | 'rate_limit'   // レート制限
  | 'api'          // APIエラー（400, 500系）
  | 'timeout'      // タイムアウト
  | 'cancelled'    // ユーザーキャンセル
  | 'unknown'      // 不明なエラー
```

### T-101-03: レート制限管理
```typescript
class RateLimitManager {
  private callHistory: number[]
  private maxCallsPerHour: number
  
  canMakeCall(): boolean
  recordCall(): void
  getWaitTime(): number
  getRemainingCalls(): number
}
```

## テスト要件

### 単体テスト
- [ ] 正常なページネーション処理のテスト
- [ ] エラー時のリトライ処理のテスト
- [ ] レート制限処理のテスト
- [ ] 進捗トラッキングのテスト
- [ ] データ統合処理のテスト

### 統合テスト
- [ ] Meta API実際の呼び出しテスト
- [ ] 大量データ取得テスト（50ページ以上）
- [ ] ネットワーク障害シミュレーションテスト
- [ ] 同時実行テスト

### エッジケーステスト
- [ ] 0ページ（データなし）の処理
- [ ] 1ページのみの処理
- [ ] 途中でデータが変更される場合の処理
- [ ] 不正なページネーションURLの処理

## パフォーマンステスト要件

### 負荷テスト
- [ ] 100ページ連続取得テスト
- [ ] 5並行リクエストでの安定性テスト
- [ ] メモリリーク検出テスト
- [ ] 長時間実行テスト（30分以上）

### 境界値テスト
- [ ] 最大ページ数制限のテスト
- [ ] 最大リトライ回数のテスト
- [ ] レート制限ぎりぎりでの動作テスト
- [ ] メモリ制限近辺での動作テスト

## セキュリティ要件

### S-101-01: 認証情報の保護
- [ ] アクセストークンの安全な取り扱い
- [ ] ログにトークンが出力されないこと
- [ ] エラーメッセージにトークンが含まれないこと

### S-101-02: データ保護
- [ ] 取得データの安全な保存
- [ ] 一時データの適切なクリーンアップ
- [ ] メモリ上の機密データの消去

## 運用要件

### O-101-01: 監視・ログ
- [ ] API呼び出し成功/失敗の記録
- [ ] レート制限状況の記録
- [ ] パフォーマンスメトリクスの記録
- [ ] エラー発生時のアラート

### O-101-02: 設定管理
- [ ] 環境変数による設定変更
- [ ] ランタイムでの設定調整（デバッグ時）
- [ ] 設定値の妥当性検証

## 実装優先順位

### Phase 1: 基本機能（必須）
1. 基本ページネーション処理
2. 簡単なエラーハンドリング
3. 進捗表示

### Phase 2: 堅牢性（重要）
1. リトライ機能
2. レート制限対応
3. 詳細エラーハンドリング

### Phase 3: 最適化（望ましい）
1. 並行処理
2. メモリ最適化
3. キャンセル機能

## 成功指標

### 定量指標
- [ ] テストカバレッジ95%以上
- [ ] 100ページ取得を10分以内で完了
- [ ] エラー率1%以下
- [ ] メモリ使用量100MB以下

### 定性指標
- [ ] 透明で理解しやすい進捗表示
- [ ] 安定したエラー回復
- [ ] 保守しやすいコード構造
- [ ] 包括的なドキュメント

## 制約・前提条件

### 技術制約
- Meta Graph API v23.0を使用
- React 19 + TypeScript環境
- 既存のConvexデータベース構造を活用
- Vite開発環境での動作

### 業務制約
- Meta APIのレート制限（200 calls/hour）
- アクセストークンの有効期限
- データ取得可能期間の制限

### リソース制約
- ブラウザメモリ制限
- ネットワーク帯域制限
- 処理時間制限（ユーザビリティ）

## リスク・対策

### 高リスク
- **Meta APIの仕様変更**: 定期的なAPI仕様確認、バージョン固定
- **レート制限超過**: 適切な制限監視、ユーザー通知
- **大量データによるメモリ不足**: ストリーミング処理、データ分割

### 中リスク
- **ネットワーク不安定**: 堅牢なリトライ機能、タイムアウト設定
- **ユーザーの処理中断**: 適切な状態保存、復旧機能

### 低リスク
- **UIの応答性低下**: 非同期処理、プログレス表示
- **ブラウザ互換性**: モダンブラウザ対応、ポリフィル使用