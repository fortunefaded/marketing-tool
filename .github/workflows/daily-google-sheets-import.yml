name: æ¯æ—¥ã®Google Sheetsãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ

on:
  schedule:
    # æ¯æ—¥ æ—¥æœ¬æ™‚é–“åˆå‰9æ™‚ (UTC 0æ™‚) ã«å®Ÿè¡Œ
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  import-google-sheets-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup Convex
        run: npx convex dev --once --url ${{ secrets.CONVEX_URL }}
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY }}

      - name: Execute daily Google Sheets import
        run: |
          echo "ğŸš€ æ¯æ—¥ã®Google Sheetsãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’é–‹å§‹"
          node -e "
            const { ConvexHttpClient } = require('convex/browser');
            const { api } = require('./convex/_generated/api.js');

            const client = new ConvexHttpClient(process.env.CONVEX_URL);

            async function runDailyImport() {
              try {
                console.log('ğŸ“Š dailyImportGoogleSheetsDataé–¢æ•°ã‚’å®Ÿè¡Œä¸­...');
                const result = await client.action(api.googleSheets.dailyImportGoogleSheetsData, {});

                if (result.success) {
                  console.log('âœ… ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ:', result.message);
                  console.log('ğŸ“ˆ ã‚¤ãƒ³ãƒãƒ¼ãƒˆä»¶æ•°:', result.imported || 0);
                  process.exit(0);
                } else {
                  console.error('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—:', result.error);
                  process.exit(1);
                }
              } catch (error) {
                console.error('ğŸ”¥ å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
                process.exit(1);
              }
            }

            runDailyImport();
          "
        env:
          CONVEX_URL: ${{ secrets.CONVEX_URL }}

      - name: Notify completion
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "ğŸ‰ Google Sheetsãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ Google Sheetsãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
          fi